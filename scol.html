<script>
    // DỮ LIỆU KHỞI TẠO TỔNG HỢP (totalData)
    let totalData = [
        {"khuVuc": "Quá nhiệt trung gian", "soDoanOngCan": 167, "soMoiBPCan": 141, "tongMoiHanCan": 467, "soDoanOngLam": 0, "soMoiBPLam": 0, "tongMoiHanLam": 0, "ghiChu": ""},
        {"khuVuc": "Quá nhiệt cấp 1", "soDoanOngCan": 97, "soMoiBPCan": 180, "tongMoiHanCan": 373, "soDoanOngLam": 0, "soMoiBPLam": 0, "tongMoiHanLam": 0, "ghiChu": ""},
        {"khuVuc": "Quá nhiệt cấp 3", "soDoanOngCan": 422, "soMoiBPCan": 0, "tongMoiHanCan": 844, "soDoanOngLam": 0, "soMoiBPLam": 0, "tongMoiHanLam": 0, "ghiChu": ""},
        {"khuVuc": "Bộ hâm nước", "soDoanOngCan": 115, "soMoiBPCan": 62, "tongMoiHanCan": 292, "soDoanOngLam": 0, "soMoiBPLam": 0, "tongMoiHanLam": 0, "ghiChu": ""},
        {"khuVuc": "Quá nhiệt hộp: Trần", "soDoanOngCan": 8, "soMoiBPCan": 8, "tongMoiHanCan": 20, "soDoanOngLam": 0, "soMoiBPLam": 0, "tongMoiHanLam": 0, "ghiChu": ""},
        {"khuVuc": "Ống sinh hơi", "soDoanOngCan": 0, "soMoiBPCan": 0, "tongMoiHanCan": 0, "soDoanOngLam": 0, "soMoiBPLam": 0, "tongMoiHanLam": 0, "ghiChu": ""},
        {"khuVuc": "Phục hồi giàn 82", "soDoanOngCan": 40, "soMoiBPCan": 63, "tongMoiHanCan": 101, "soDoanOngLam": 0, "soMoiBPLam": 0, "tongMoiHanLam": 0, "ghiChu": ""},
    ];

    let detailData = [
        {"khuVuc":"Quá nhiệt trung gian", "hangMuc":"TQNTG T5/ Giàn 5-1", "duongKinh":50.8, "chieuDayDanhDinh":4.19, "chieuDayThuc":3.14,"chieuDaiDoanOngThayThe": 2.5, "phuongAn":"Cắt thay","queHanSuDung":"ER70S-6","khoiLuongCanLam":1,"soMoiHanCanLam":2, "soMoiBPCanLam":1, "catLam":1,"hanMoi1Lam":1,"hanMoi2Lam":0,"soMoiBPLam":1,"soDoanOngLam":1,"ghiChu":"Hoàn thành cắt và hàn mối 1"},
        {"khuVuc":"Quá nhiệt cấp 1", "hangMuc":"TQNC1 T5/ Giàn 5-4", "duongKinh":50.8, "chieuDayDanhDinh":4.57, "chieuDayThuc":3.4,"chieuDaiDoanOngThayThe": 1.2, "phuongAn":"Cắt thay","queHanSuDung":"ER80S-B2","khoiLuongCanLam":1,"soMoiHanCanLam":2,"soMoiBPCanLam":0,"catLam":1,"hanMoi1Lam":1,"hanMoi2Lam":1,"soMoiBPLam":0,"soDoanOngLam":1,"ghiChu":"Đã hàn xong"},
    ];
    let currentDetailKhuVuc = '';

    // ************************************************************
    // CHỨC NĂNG IMPORT/EXPORT
    // ************************************************************

    function handlePlanUpload(event) {
        // Kiểm tra thư viện XLSX trước khi chạy
        if (typeof XLSX === 'undefined') {
            alert("Lỗi: Không tìm thấy thư viện XLSX (SheetJS). Vui lòng kiểm tra lại thẻ <script> CDN.");
            return;
        }

        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                
                // Lấy dữ liệu từ hàng 3 (range: 2)
                const newPlanData = XLSX.utils.sheet_to_json(worksheet, {
                    header: ["STT_Ignore", "khuVuc", "soDoanOngCan", "soMoiBPCan", "tongMoiHanCan"],
                    range: 2, 
                    raw: false
                });

                let updatedPlanData = newPlanData.filter(item => item.khuVuc).map(item => ({
                    khuVuc: item.khuVuc.trim(),
                    soDoanOngCan: parseInt(item.soDoanOngCan) || 0,
                    soMoiBPCan: parseInt(item.soMoiBPCan) || 0,
                    tongMoiHanCan: parseInt(item.tongMoiHanCan) || 0,
                    soDoanOngLam: 0, 
                    soMoiBPLam: 0,   
                    tongMoiHanLam: 0, 
                    ghiChu: ""
                }));

                let tempTotalData = totalData;
                totalData = updatedPlanData.map(newPlan => {
                    const existingItem = tempTotalData.find(old => old.khuVuc === newPlan.khuVuc);
                    if (existingItem) {
                        return {
                            ...newPlan,
                            soDoanOngLam: existingItem.soDoanOngLam,
                            soMoiBPLam: existingItem.soMoiBPLam,
                            tongMoiHanLam: existingItem.tongMoiHanLam,
                            ghiChu: existingItem.ghiChu 
                        };
                    }
                    return newPlan;
                });
                
                const existingKhuVucNames = updatedPlanData.map(item => item.khuVuc);
                totalData.push(...tempTotalData.filter(old => 
                    !existingKhuVucNames.includes(old.khuVuc) && (old.soDoanOngLam > 0 || old.tongMoiHanLam > 0)
                ));


                updateTotalDataFromDetail(); 
                showTotalView();
                alert(`Đã tải thành công và cập nhật ${totalData.length} khu vực KẾ HOẠCH!`);
            } catch (error) {
                alert("Lỗi khi đọc file Kế hoạch. Vui lòng kiểm tra định dạng và vị trí cột: " + error.message);
            } finally {
                document.getElementById('plan-file-input').value = '';
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function handleDetailUpload(event) {
        if (typeof XLSX === 'undefined') {
            alert("Lỗi: Không tìm thấy thư viện XLSX (SheetJS). Vui lòng kiểm tra lại thẻ <script> CDN.");
            return;
        }

        const file = event.target.files[0];
        if (!file) return;

        if (!currentDetailKhuVuc) {
            alert("Vui lòng click vào một Khu vực ở bảng tổng hợp trước khi Import Chi tiết.");
            document.getElementById('detail-file-input').value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                
                const aoa = XLSX.utils.sheet_to_json(worksheet, {
                    header: 1, 
                    range: 0, 
                    raw: false, 
                    defval: "" 
                });
                
                const dataRows = aoa.slice(3); 
                
                const khuVucHienTai = currentDetailKhuVuc;
                let importedData = [];

                // Cột Index (0-based) dựa trên cấu trúc file mẫu
                const COL_HANGMUC = 3; 
                const COL_DUONGKINH = 4;
                const COL_CHIEUDAY_DANHDINH = 5;
                const COL_CHIEUDAY_THUC = 6;
                const COL_CHIEUDAI_ONG = 7;
                const COL_QUEHAN = 8;
                const COL_PHUONGAN = 9;
                const COL_KL_CANLAM = 10;
                const COL_MOIHAN_CANLAM = 11;
                const COL_MOIBP_CANLAM = 12;
                const COL_CAT_LAM = 13;
                const COL_HAN1_LAM = 14;
                const COL_HAN2_LAM = 15;
                const COL_MOIBP_LAM = 16;
                const COL_DOANONG_LAM = 17;
                const COL_GHICHU = 18;
                
                const getFloat = (row, index) => {
                    const val = row[index];
                    return typeof val === 'number' ? val : (parseFloat(String(val).replace(/,/g, '.')) || 0);
                };
                const getInt = (row, index) => {
                    const val = row[index];
                    return typeof val === 'number' ? val : (parseInt(String(val).replace(/,/g, '.')) || 0);
                };
                const getString = (row, index) => (row[index] || '').trim();


                dataRows.forEach(row => {
                    const hangMuc = getString(row, COL_HANGMUC);
                    const klCanLam = getInt(row, COL_KL_CANLAM);
                    const mhCanLam = getInt(row, COL_MOIHAN_CANLAM);

                    if (!hangMuc || (klCanLam === 0 && mhCanLam === 0)) {
                        return; 
                    }

                    importedData.push({
                        khuVuc: khuVucHienTai, 
                        hangMuc: hangMuc,
                        duongKinh: getFloat(row, COL_DUONGKINH),
                        chieuDayDanhDinh: getFloat(row, COL_CHIEUDAY_DANHDINH),
                        chieuDayThuc: getFloat(row, COL_CHIEUDAY_THUC),
                        chieuDaiDoanOngThayThe: getFloat(row, COL_CHIEUDAI_ONG),
                        phuongAn: getString(row, COL_PHUONGAN),
                        queHanSuDung: getString(row, COL_QUEHAN),
                        
                        khoiLuongCanLam: klCanLam,
                        soMoiHanCanLam: mhCanLam,
                        soMoiBPCanLam: getInt(row, COL_MOIBP_CANLAM),
                        
                        catLam: getInt(row, COL_CAT_LAM),
                        hanMoi1Lam: getInt(row, COL_HAN1_LAM),
                        hanMoi2Lam: getInt(row, COL_HAN2_LAM),
                        soMoiBPLam: getInt(row, COL_MOIBP_LAM),
                        soDoanOngLam: getInt(row, COL_DOANONG_LAM),
                        ghiChu: getString(row, COL_GHICHU)
                    });
                });

                // Xóa dữ liệu cũ của khu vực hiện tại và thêm dữ liệu mới
                detailData = detailData.filter(item => item.khuVuc !== khuVucHienTai);
                detailData.push(...importedData); 

                updateTotalDataFromDetail(); 
                
                if(document.getElementById('view-detail').style.display === 'block') {
                    applyDetailFilters();
                } else {
                    showTotalView();
                }
                
                alert(`Đã tải thành công và GHI ĐÈ ${importedData.length} mục dữ liệu CHI TIẾT cho khu vực ${khuVucHienTai}!`);

            } catch (error) {
                alert("Lỗi khi đọc file Chi tiết. Vui lòng kiểm tra định dạng và thứ tự cột: " + error.message);
            } finally {
                document.getElementById('detail-file-input').value = '';
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function downloadDataAsExcel() {
        if (typeof XLSX === 'undefined') {
            alert("Lỗi: Không tìm thấy thư viện XLSX (SheetJS). Vui lòng kiểm tra lại thẻ <script> CDN.");
            return;
        }
        
        if (detailData.length === 0) {
            alert("Không có dữ liệu chi tiết để tải về.");
            return;
        }

        const headers = [
            "Khu vực", "Hạng mục", "Đường kính", "Chiều dày Danh Định", "Chiều dày Thực", "Chiều dài đoạn ống thay thế", 
            "Que hàn sử dụng", "Phương án", "KL Cần làm (Đoạn ống)", "Tổng mối hàn CẦN", "Mối BP CẦN", 
            "Đã làm: Cắt", "Đã làm: Hàn mối 1", "Đã làm: Hàn mối 2", "Đã làm: Mối BP", "Đã làm: Đoạn ống", "Ghi chú"
        ];
        
        const dataForExport = detailData.map(item => [
            item.khuVuc, item.hangMuc, item.duongKinh, item.chieuDayDanhDinh, item.chieuDayThuc, item.chieuDaiDoanOngThayThe, 
            item.queHanSuDung, item.phuongAn, item.khoiLuongCanLam, item.soMoiHanCanLam, item.soMoiBPCanLam, 
            item.catLam, item.hanMoi1Lam, item.hanMoi2Lam, item.soMoiBPLam, item.soDoanOngLam, item.ghiChu
        ]);

        const ws = XLSX.utils.aoa_to_sheet([headers, ...dataForExport]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "DuLieuChiTiet");

        XLSX.writeFile(wb, "DuLieuChiTiet_DaiTuLo1_" + new Date().toISOString().slice(0, 10) + ".xlsx");
    }

    // ************************************************************
    // CÁC HÀM XỬ LÝ DỮ LIỆU & GIAO DIỆN
    // ************************************************************
    
    function updateTotalDataFromDetail() {
        const planMapFromDetail = {};
        const summaryMapFromDetail = {};

        detailData.forEach(item => {
            const khuVuc = item.khuVuc.trim();
            if (!planMapFromDetail[khuVuc]) {
                planMapFromDetail[khuVuc] = { soDoanOngCan: 0, soMoiBPCan: 0, tongMoiHanCan: 0 };
                summaryMapFromDetail[khuVuc] = { soDoanOngLam: 0, soMoiBPLam: 0, tongMoiHanLam: 0 };
            }
            
            planMapFromDetail[khuVuc].soDoanOngCan += parseInt(item.khoiLuongCanLam || 0);
            planMapFromDetail[khuVuc].soMoiBPCan += parseInt(item.soMoiBPCanLam || 0); 
            planMapFromDetail[khuVuc].tongMoiHanCan += parseInt(item.soMoiHanCanLam || 0);

            summaryMapFromDetail[khuVuc].soDoanOngLam += parseInt(item.soDoanOngLam || 0);
            summaryMapFromDetail[khuVuc].soMoiBPLam += parseInt(item.soMoiBPLam || 0);
            summaryMapFromDetail[khuVuc].tongMoiHanLam += parseInt(item.catLam || 0) + parseInt(item.hanMoi1Lam || 0) + parseInt(item.hanMoi2Lam || 0); 
        });

        const newTotalData = [];
        const allKhuVuc = new Set([...totalData.map(item => item.khuVuc), ...Object.keys(planMapFromDetail)]);

        allKhuVuc.forEach(khuVuc => {
            const existingItem = totalData.find(old => old.khuVuc === khuVuc);
            const summary = summaryMapFromDetail[khuVuc] || { soDoanOngLam: 0, soMoiBPLam: 0, tongMoiHanLam: 0 };
            const planFromDetail = planMapFromDetail[khuVuc];
            
            let updatedItem = { khuVuc: khuVuc, ghiChu: (existingItem ? existingItem.ghiChu : '') || '' };
            
            const hasDetailPlan = planFromDetail && (planFromDetail.soDoanOngCan > 0 || planFromDetail.tongMoiHanCan > 0);
            
            if (hasDetailPlan) {
                updatedItem.soDoanOngCan = planFromDetail.soDoanOngCan;
                updatedItem.soMoiBPCan = planFromDetail.soMoiBPCan;
                updatedItem.tongMoiHanCan = planFromDetail.tongMoiHanCan;
            } else if (existingItem) {
                updatedItem.soDoanOngCan = existingItem.soDoanOngCan;
                updatedItem.soMoiBPCan = existingItem.soMoiBPCan;
                updatedItem.tongMoiHanCan = existingItem.tongMoiHanCan;
            } else {
                updatedItem.soDoanOngCan = 0;
                updatedItem.soMoiBPCan = 0;
                updatedItem.tongMoiHanCan = 0;
            }

            updatedItem.soDoanOngLam = summary.soDoanOngLam;
            updatedItem.soMoiBPLam = summary.soMoiBPLam;
            updatedItem.tongMoiHanLam = summary.tongMoiHanLam;

            if (updatedItem.soDoanOngCan === 0 && updatedItem.tongMoiHanCan === 0 && updatedItem.soDoanOngLam === 0 && updatedItem.tongMoiHanLam === 0) {
                return;
            }

            newTotalData.push(updatedItem);
        });

        totalData = newTotalData;
        renderTotalTable();
    }


    function renderTotalTable() {
        const tbody = document.getElementById('total-data-body');
        const totalDataTable = document.getElementById('total-data-table');
        if (!tbody || !totalDataTable) return; // Bảo vệ khỏi lỗi DOM

        tbody.innerHTML = '';
        let totals = { canOng: 0, canBP: 0, canHan: 0, lamOng: 0, lamBP: 0, lamHan: 0 };

        totalData.forEach(item => {
            const soDoanOngConLai = item.soDoanOngCan - item.soDoanOngLam;
            const soMoiBPConLai = item.soMoiBPCan - item.soMoiBPLam;
            const tongMoiHanConLai = item.tongMoiHanCan - item.tongMoiHanLam;

            const percentDoanOng = item.soDoanOngCan > 0 ? (item.soDoanOngLam / item.soDoanOngCan * 100).toFixed(1) : 0;
            const percentMoiHan = item.tongMoiHanCan > 0 ? (item.tongMoiHanLam / item.tongMoiHanCan * 100).toFixed(1) : 0;

            const row = tbody.insertRow();
            row.onclick = () => showDetailView(item.khuVuc);
            
            row.insertCell().textContent = item.khuVuc; 
            row.insertCell().textContent = item.soDoanOngCan;
            row.insertCell().textContent = item.soMoiBPCan;
            row.insertCell().textContent = item.tongMoiHanCan;
            row.insertCell().textContent = item.soDoanOngLam;
            row.insertCell().textContent = item.soMoiBPLam;
            row.insertCell().textContent = item.tongMoiHanLam;
            row.insertCell().textContent = soDoanOngConLai;
            row.insertCell().textContent = soMoiBPConLai;
            row.insertCell().textContent = tongMoiHanConLai;
            
            const cellPercentOng = row.insertCell();
            cellPercentOng.textContent = percentDoanOng + '%';
            cellPercentOng.style.backgroundColor = percentDoanOng == 100 ? '#d4edda' : (percentDoanOng > 0 ? '#fff3cd' : '');
            
            const cellPercentHan = row.insertCell();
            cellPercentHan.textContent = percentMoiHan + '%';
            cellPercentHan.style.backgroundColor = percentMoiHan == 100 ? '#d4edda' : (percentMoiHan > 0 ? '#fff3cd' : '');
            
            row.insertCell().textContent = item.ghiChu;

            // Tính tổng cộng
            totals.canOng += item.soDoanOngCan;
            totals.canBP += item.soMoiBPCan;
            totals.canHan += item.tongMoiHanCan;
            totals.lamOng += item.soDoanOngLam;
            totals.lamBP += item.soMoiBPLam;
            totals.lamHan += item.tongMoiHanLam;
        });

        // Xóa tfoot cũ
        let existingTfoot = totalDataTable.querySelector('tfoot');
        if (existingTfoot) existingTfoot.remove();

        // Thêm tfoot mới
        const tfoot = document.createElement('tfoot');
        const totalRow = tfoot.insertRow();
        totalRow.style.fontWeight = 'bold';
        totalRow.style.backgroundColor = '#007bff';
        totalRow.style.color = 'white';
        
        const totalPercentDoanOng = totals.canOng > 0 ? (totals.lamOng / totals.canOng * 100).toFixed(1) : 0;
        const totalPercentMoiHan = totals.canHan > 0 ? (totals.lamHan / totals.canHan * 100).toFixed(1) : 0;

        totalRow.insertCell().textContent = "TỔNG CỘNG";
        totalRow.insertCell().textContent = totals.canOng;
        totalRow.insertCell().textContent = totals.canBP;
        totalRow.insertCell().textContent = totals.canHan;
        totalRow.insertCell().textContent = totals.lamOng;
        totalRow.insertCell().textContent = totals.lamBP;
        totalRow.insertCell().textContent = totals.lamHan;
        totalRow.insertCell().textContent = totals.canOng - totals.lamOng;
        totalRow.insertCell().textContent = totals.canBP - totals.lamBP;
        totalRow.insertCell().textContent = totals.canHan - totals.lamHan;
        totalRow.insertCell().textContent = totalPercentDoanOng + '%';
        totalRow.insertCell().textContent = totalPercentMoiHan + '%';
        totalRow.insertCell().textContent = "";
        
        totalDataTable.appendChild(tfoot);

        // Hiển thị nút quản lý file kế hoạch
        const fileManagement = document.getElementById('hidden-file-management');
        if (fileManagement) fileManagement.style.display = 'flex';
    }


    function showDetailView(khuVuc) {
        currentDetailKhuVuc = khuVuc;
        document.getElementById('view-total').style.display = 'none';
        document.getElementById('hidden-file-management').style.display = 'none';
        document.getElementById('view-detail').style.display = 'block';
        document.getElementById('detail-header').textContent = `CHI TIẾT TIẾN ĐỘ KHU VỰC: ${khuVuc}`;
        document.getElementById('khuVuc').value = khuVuc;
        document.getElementById('current-khuVuc-update').textContent = khuVuc;
        document.getElementById('filterHangMuc').value = '';
        applyDetailFilters();
        resetForm();
    }

    function showTotalView() {
        document.getElementById('view-total').style.display = 'block';
        document.getElementById('hidden-file-management').style.display = 'flex';
        document.getElementById('view-detail').style.display = 'none';
        renderTotalTable();
    }

    function applyDetailFilters() {
        const tbody = document.getElementById('data-body');
        const filterText = document.getElementById('filterHangMuc').value.toLowerCase().trim();
        const tfoot = document.getElementById('data-tfoot');
        if (!tbody || !tfoot) return;

        tbody.innerHTML = '';
        let sttCounter = 1;
        let filteredData = detailData.filter(item => item.khuVuc === currentDetailKhuVuc && item.hangMuc.toLowerCase().includes(filterText));

        let totals = { canOng: 0, canHan: 0, canBP: 0, lamCat: 0, lamHan1: 0, lamHan2: 0, lamBP: 0, lamOng: 0 };

        filteredData.forEach((item, index) => {
            const row = tbody.insertRow();
            // Lấy index trong mảng detailData
            const detailDataIndex = detailData.findIndex(d => d.khuVuc === item.khuVuc && d.hangMuc === item.hangMuc);
            row.onclick = () => loadRowToForm(item, detailDataIndex);
            
            row.insertCell().textContent = sttCounter++; 
            row.insertCell().textContent = item.hangMuc; 
            row.insertCell().textContent = item.duongKinh || '';
            row.insertCell().textContent = item.chieuDayDanhDinh || '';
            row.insertCell().textContent = item.chieuDayThuc || '';
            row.insertCell().textContent = item.chieuDaiDoanOngThayThe || '';
            row.insertCell().textContent = item.phuongAn || '';
            row.insertCell().textContent = item.queHanSuDung || '';
            
            row.insertCell().textContent = item.khoiLuongCanLam || '';
            row.insertCell().textContent = item.soMoiHanCanLam || '';
            row.insertCell().textContent = item.soMoiBPCanLam || '';
            
            row.insertCell().textContent = item.catLam || 0;
            row.insertCell().textContent = item.hanMoi1Lam || 0;
            row.insertCell().textContent = item.hanMoi2Lam || 0;
            row.insertCell().textContent = item.soMoiBPLam || 0;
            row.insertCell().textContent = item.soDoanOngLam || 0;
            
            row.insertCell().textContent = item.ghiChu || '';

            // Tính tổng
            totals.canOng += parseInt(item.khoiLuongCanLam || 0);
            totals.canHan += parseInt(item.soMoiHanCanLam || 0);
            totals.canBP += parseInt(item.soMoiBPCanLam || 0);
            totals.lamCat += parseInt(item.catLam || 0);
            totals.lamHan1 += parseInt(item.hanMoi1Lam || 0);
            totals.lamHan2 += parseInt(item.hanMoi2Lam || 0);
            totals.lamBP += parseInt(item.soMoiBPLam || 0);
            totals.lamOng += parseInt(item.soDoanOngLam || 0);
        });

        // Cập nhật tfoot
        tfoot.innerHTML = '';
        const footerRow = tfoot.insertRow();
        footerRow.style.fontWeight = 'bold';
        footerRow.style.backgroundColor = '#f1f1f1';
        
        footerRow.insertCell().textContent = ''; 
        footerRow.insertCell().textContent = 'TỔNG CỘNG';
        footerRow.insertCell().colSpan = 6; 
        
        footerRow.insertCell().textContent = totals.canOng;
        footerRow.insertCell().textContent = totals.canHan;
        footerRow.insertCell().textContent = totals.canBP;
        
        footerRow.insertCell().textContent = totals.lamCat;
        footerRow.insertCell().textContent = totals.lamHan1;
        footerRow.insertCell().textContent = totals.lamHan2;
        footerRow.insertCell().textContent = totals.lamBP;
        footerRow.insertCell().textContent = totals.lamOng;

        footerRow.insertCell().textContent = ''; 

        document.getElementById('stt').value = filteredData.length + 1;
    }

    document.getElementById('add-row-btn').addEventListener('click', () => {
        const khuVuc = document.getElementById('khuVuc').value;
        const hangMuc = document.getElementById('hangMuc').value.trim();
        
        if (!hangMuc) {
            alert("Hạng mục không được để trống!");
            return;
        }

        const newData = {
            khuVuc: khuVuc,
            hangMuc: hangMuc,
            duongKinh: parseFloat(document.getElementById('duongKinh').value) || 0,
            chieuDayDanhDinh: parseFloat(document.getElementById('chieuDayDanhDinh').value) || 0,
            chieuDayThuc: parseFloat(document.getElementById('chieuDayThuc').value) || 0,
            chieuDaiDoanOngThayThe: parseFloat(document.getElementById('chieuDaiDoanOngThayThe').value) || 0,
            phuongAn: document.getElementById('phuongAn').value,
            queHanSuDung: document.getElementById('queHanSuDung').value,
            
            khoiLuongCanLam: parseInt(document.getElementById('khoiLuongCanLam').value) || 0,
            soMoiHanCanLam: parseInt(document.getElementById('soMoiHanCanLam').value) || 0,
            soMoiBPCanLam: parseInt(document.getElementById('soMoiBPCanLam').value) || 0,
            
            catLam: parseInt(document.getElementById('catLam').value) || 0,
            hanMoi1Lam: parseInt(document.getElementById('hanMoi1Lam').value) || 0,
            hanMoi2Lam: parseInt(document.getElementById('hanMoi2Lam').value) || 0,
            soMoiBPLam: parseInt(document.getElementById('soMoiBPLam').value) || 0,
            soDoanOngLam: parseInt(document.getElementById('soDoanOngLam').value) || 0,
            
            ghiChu: document.getElementById('ghiChu').value.trim()
        };

        const existingIndex = detailData.findIndex(item => item.khuVuc === khuVuc && item.hangMuc === hangMuc);

        if (existingIndex !== -1) {
            detailData[existingIndex] = newData;
            alert(`Đã CẬP NHẬT tiến độ cho hạng mục: ${hangMuc}`);
        } else {
            detailData.push(newData);
            alert(`Đã THÊM MỚI hạng mục: ${hangMuc}`);
        }

        updateTotalDataFromDetail();
        applyDetailFilters();
        resetForm();
    });

    function loadRowToForm(item, index) {
        document.getElementById('stt').value = document.getElementById('data-body').rows.findIndex(row => row.onclick.toString().includes(item.hangMuc)) + 1;
        document.getElementById('khuVuc').value = item.khuVuc;
        document.getElementById('hangMuc').value = item.hangMuc;
        document.getElementById('duongKinh').value = item.duongKinh;
        document.getElementById('chieuDayDanhDinh').value = item.chieuDayDanhDinh;
        document.getElementById('chieuDayThuc').value = item.chieuDayThuc;
        document.getElementById('chieuDaiDoanOngThayThe').value = item.chieuDaiDoanOngThayThe;
        document.getElementById('phuongAn').value = item.phuongAn;
        document.getElementById('queHanSuDung').value = item.queHanSuDung;

        document.getElementById('khoiLuongCanLam').value = item.khoiLuongCanLam;
        document.getElementById('soMoiHanCanLam').value = item.soMoiHanCanLam;
        document.getElementById('soMoiBPCanLam').value = item.soMoiBPCanLam;

        document.getElementById('catLam').value = item.catLam;
        document.getElementById('hanMoi1Lam').value = item.hanMoi1Lam;
        document.getElementById('hanMoi2Lam').value = item.hanMoi2Lam;
        document.getElementById('soMoiBPLam').value = item.soMoiBPLam;
        document.getElementById('soDoanOngLam').value = item.soDoanOngLam;
        
        document.getElementById('ghiChu').value = item.ghiChu;
    }

    function resetForm() {
        const nextStt = document.getElementById('data-body') ? document.getElementById('data-body').rows.length + 1 : 1;

        document.getElementById('stt').value = nextStt;
        document.getElementById('hangMuc').value = '';
        document.getElementById('duongKinh').value = '50.80';
        document.getElementById('chieuDayDanhDinh').value = '4.57';
        document.getElementById('chieuDayThuc').value = '3.41';
        document.getElementById('chieuDaiDoanOngThayThe').value = '1.0';
        document.getElementById('queHanSuDung').value = 'ER80S-B2';
        document.getElementById('phuongAn').value = 'Cắt thay';
        document.getElementById('khoiLuongCanLam').value = '1';
        document.getElementById('soMoiHanCanLam').value = '2';
        document.getElementById('soMoiBPCanLam').value = '0';
        document.getElementById('catLam').value = '0';
        document.getElementById('hanMoi1Lam').value = '0';
        document.getElementById('hanMoi2Lam').value = '0';
        document.getElementById('soMoiBPLam').value = '0';
        document.getElementById('soDoanOngLam').value = '0';
        document.getElementById('ghiChu').value = '';
        
        document.getElementById('hangMuc').focus();
    }

    // Khởi tạo bảng tổng hợp khi DOM đã tải xong
    document.addEventListener('DOMContentLoaded', function() {
        // Gán các hàm xử lý cho input file sau khi DOM sẵn sàng
        const planInput = document.getElementById('plan-file-input');
        if (planInput) planInput.onchange = handlePlanUpload;
        
        const detailInput = document.getElementById('detail-file-input');
        if (detailInput) detailInput.onchange = handleDetailUpload;

        // Bắt đầu khởi tạo dữ liệu và giao diện
        updateTotalDataFromDetail(); 
        showTotalView();
    });

</script>
