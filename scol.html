<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QUẢN LÝ TIẾN ĐỘ SỬA CHỮA ĐẠI TU ỐNG LÒ SỐ 1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        /* CSS (Giữ nguyên) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #e9ecef;
            color: #333;
        }
        #main-header {
            background-color: #004085;
            color: white;
            padding: 20px 20px;
            font-size: 26px;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        #content-area {
            padding: 20px;
        }
        h2 {
            color: #0056b3;
            border-bottom: 2px solid #0056b3;
            padding-bottom: 8px;
            margin-top: 30px;
            font-size: 20px;
        }
        .file-management-section {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        #file-management-detail, #file-management-plan {
             border-left: 5px solid #17a2b8; 
        }
        #file-management-plan {
            border-left: 5px solid #ffc107; 
        }
        .upload-label, .download-btn, #plan-upload-label {
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            border: none;
        }
        #detail-upload-label, #detail-upload-label-in-detail {
            background-color: #28a745; 
            color: white;
        }
        #detail-upload-label:hover, #detail-upload-label-in-detail:hover {
            background-color: #1e7e34;
        }
        .download-btn {
            background-color: #007bff; 
            color: white;
        }
        .download-btn:hover {
            background-color: #0056b3;
        }
        #plan-upload-label {
            background-color: #ffc107; 
            color: #343a3d;
        }
        #plan-upload-label:hover {
            background-color: #e0a800;
        }
        .excel-file-input {
            display: none;
        }
        #input-form {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            border-left: 5px solid #dc3545; 
        }
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .form-group {
            flex: 1 1 150px; 
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 3px;
            color: #0056b3;
        }
        .form-group input, .form-group select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
            box-sizing: border-box;
        }
        .form-group.full-width {
            flex: 1 1 100%;
        }
        .button-group {
            flex: 1 1 200px;
            justify-content: flex-end;
        }
        #add-row-btn {
            background-color: #dc3545;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            table-layout: fixed;
        }
        #total-data-table {
            table-layout: auto; 
        }
        th, td {
            border: 1px solid #cce5ff;
            padding: 8px 5px; 
            text-align: left;
            font-size: 12px; 
            vertical-align: top;
            word-wrap: break-word;
        }
        th {
            background-color: #0056b3;
            color: white;
            font-weight: bold;
            text-align: center;
            border-color: #004085;
        }
        #data-table thead tr:nth-child(2) th {
            background-color: #4CAF50;
            color: white;
            font-weight: normal;
        }
        #data-table thead tr:nth-child(3) th {
            background-color: #6c757d;
            color: white;
            font-weight: normal;
        }
        .text-center { text-align: center; }
        .back-button {
            background-color: #6c757d;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 20px;
            display: inline-block;
        }
        #total-data-body tr:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="main-header">QUẢN LÝ TIẾN ĐỘ SỬA CHỮA ĐẠI TU ỐNG LÒ SỐ 1</div>

    <div id="content-area">

        <div id="view-total">
            <h2>Tiến Độ Tổng Hợp Toàn Bộ Công Việc</h2>
            <table id="total-data-table">
                <thead>
                    <tr>
                        <th rowspan="2" style="width: 15%;">Khu vực</th>
                        <th colspan="3" class="text-center">Khối lượng cần làm (Kế hoạch)</th>
                        <th colspan="3" class="text-center">Khối lượng đã làm (Thực hiện)</th>
                        <th colspan="3" class="text-center">Khối lượng còn lại</th>
                        <th colspan="2" class="text-center">% Hoàn thành</th>
                        <th rowspan="2" style="width: 10%;">Ghi chú</th>
                    </tr>
                    <tr>
                        <th style="width: 5%;">Số đoạn ống</th>
                        <th style="width: 5%;">Số mối biện pháp</th>
                        <th style="width: 7%;">Tổng số mối hàn</th>
                        <th style="width: 5%;">Số đoạn ống</th>
                        <th style="width: 5%;">Số mối biện pháp</th>
                        <th style="width: 7%;">Tổng số mối hàn</th>
                        <th style="width: 5%;">Số đoạn ống</th>
                        <th style="width: 5%;">Số mối biện pháp</th>
                        <th style="width: 7%;">Tổng số mối hàn</th>
                        <th style="width: 8%;">Theo Đoạn Ống</th>
                        <th style="width: 8%;">Theo Mối Hàn</th>
                    </tr>
                </thead>
                <tbody id="total-data-body">
                    </tbody>
            </table>
            <p style="margin-top: 20px; font-style: italic; color: #5a6268;">* Click vào tên **Khu vực** trong bảng để xem chi tiết, tìm kiếm và cập nhật tiến độ.</p>
        </div>

        <div id="hidden-file-management" style="display: none;">
            
            <h2>Quản Lý Dữ Liệu Kế Hoạch (CẦN LÀM)</h2>
            <div id="file-management-plan" class="file-management-section">
                <input type="file" id="plan-file-input" class="excel-file-input" accept=".xlsx, .xls, .csv" onchange="handlePlanUpload(event)">
                <label for="plan-file-input" id="plan-upload-label">
                    &#x2191; Cập nhật File KẾ HOẠCH TỔNG (.xlsx, .csv)
                </label>
                <span style="font-size: 12px; color: #6c757d;">(File Excel/CSV phải có 4 cột: Khu vực, Số đoạn ống cần, Số mối BP cần, Tổng mối hàn cần)</span>
            </div>
        </div>

        <div id="view-detail" style="display: none;">
            <button class="back-button" onclick="showTotalView()">&#9664; Trở về Bảng Tổng Hợp</button>

            <h2 id="detail-header"></h2>

            <h2>Quản Lý File Dữ Liệu Chi Tiết</h2>
            <div id="file-management-detail" class="file-management-section">
                <input type="file" id="detail-file-input" class="excel-file-input" accept=".xlsx, .xls, .csv" onchange="handleDetailUpload(event)">
                <label for="detail-file-input" id="detail-upload-label-in-detail" class="upload-label">
                    &#x2191; **Upload/Ghi đè** File DỮ LIỆU CHI TIẾT (.xlsx, .csv)
                </label>
                
                <button class="download-btn" onclick="downloadDataAsExcel()">
                    &#x2193; Tải về File DỮ LIỆU CHI TIẾT hiện tại (.xlsx)
                </button>
                <span style="font-size: 12px; color: #6c757d;">*Lưu ý: Upload mới sẽ thay thế toàn bộ dữ liệu chi tiết hiện có.</span>
            </div>


            <h2>Tìm Kiếm & Tra Cứu Dữ Liệu Chi Tiết</h2>
            <div id="filter-section" style="border-left: 5px solid #ffc107; padding: 15px; background-color: #fff; margin-bottom: 20px;">
                <div class="form-row">
                    <div class="form-group" style="flex: 1 1 100%;">
                        <label for="filterHangMuc">Lọc theo Hạng mục (Gõ để tìm kiếm)</label>
                        <input type="text" id="filterHangMuc" placeholder="Nhập hạng mục..." onkeyup="applyDetailFilters()">
                    </div>
                </div>
            </div>

            <h2>Nhập/Cập Nhật Dữ Liệu (<span id="current-khuVuc-update" style="color: #dc3545; font-weight: bold;"></span>)</h2>
            <div id="input-form">
                <div class="form-row">
                    <div class="form-group"><label for="stt">STT tiếp theo</label><input type="number" id="stt" value="1" readonly style="background-color: #fff3cd;"></div>
                    <div class="form-group"><label for="khuVuc">Khu vực</label><input type="text" id="khuVuc" required readonly style="background-color: #eee;"></div>
                    <div class="form-group"><label for="hangMuc">Hạng mục **(BẮT BUỘC)**</label><input type="text" id="hangMuc" value="" required></div>
                    <div class="form-group"><label for="duongKinh">Đường kính D.D. (mm)</label><input type="number" step="0.01" id="duongKinh" value="50.80"></div>
                    <div class="form-group"><label for="chieuDayDanhDinh">Chiều dày D.D. (mm)</label><input type="number" step="0.01" id="chieuDayDanhDinh" value="4.57"></div>
                </div>
                
                <div class="form-row">
                    <div class="form-group"><label for="chieuDayThuc">Chiều dày THỰC (mm)</label><input type="number" step="0.01" id="chieuDayThuc" value="3.41"></div>
                    <div class="form-group"><label for="chieuDaiDoanOngThayThe">Chiều dài đoạn ống thay thế (m)</label><input type="number" step="0.01" id="chieuDaiDoanOngThayThe" value=""></div> 
                    <div class="form-group"><label for="queHanSuDung">Que hàn sử dụng</label><input type="text" id="queHanSuDung" value="ER80S-B2"></div>
                    <div class="form-group"><label for="phuongAn">Phương án</label><select id="phuongAn">
                        <option value="Cắt thay" selected>Cắt thay</option>
                        <option value="Hàn đắp">Hàn đắp</option>
                        <option value="Phục hồi">Phục hồi</option>
                        <option value="Khác">Khác</option>
                    </select></div>
                </div>

                <div class="form-row" style="border-top: 1px dashed #ccc; padding-top: 10px;">
                    <div class="form-group"><label for="khoiLuongCanLam">KL Cần làm (Đoạn ống)</label><input type="number" step="1" id="khoiLuongCanLam" value="1"></div>
                    <div class="form-group"><label for="soMoiHanCanLam">Tổng số mối hàn CẦN</label><input type="number" step="1" id="soMoiHanCanLam" value="2"></div>
                    <div class="form-group"><label for="soMoiBPCanLam">Số mối BP CẦN</label><input type="number" step="1" id="soMoiBPCanLam" value="0"></div> 
                </div>

                <div class="form-row" style="border-top: 1px dashed #ccc; padding-top: 10px;">
                    <div class="form-group"><label for="catLam">Đã làm: Cắt</label><input type="number" id="catLam" value="0"></div>
                    <div class="form-group"><label for="hanMoi1Lam">Đã làm: Hàn mối 1</label><input type="number" id="hanMoi1Lam" value="0"></div>
                    <div class="form-group"><label for="hanMoi2Lam">Đã làm: Hàn mối 2</label><input type="number" id="hanMoi2Lam" value="0"></div> 
                    <div class="form-group"><label for="soMoiBPLam">Đã làm: Số mối BP</label><input type="number" id="soMoiBPLam" value="0"></div>
                    <div class="form-group"><label for="soDoanOngLam">Đã làm: Số đoạn ống</label><input type="number" id="soDoanOngLam" value="0"></div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width"><label for="ghiChu">Ghi chú</label><input type="text" id="ghiChu"></div>
                </div>
                
                <div class="form-row">
                    <div class="form-group button-group full-width">
                        <button id="add-row-btn">Thêm Mới / Cập Nhật Tiến Độ</button>
                    </div>
                </div>
            </div>

            <h2>Bảng Chi Tiết Dữ Liệu (Đã Lọc theo Khu vực)</h2>
            <table id="data-table">
                <thead>
                    <tr>
                        <th rowspan="3" style="width: 3%;">STT</th>
                        <th rowspan="3" style="width: 15%;">Hạng mục (Khu vực)</th>
                        <th colspan="4" class="text-center" style="width: 20%;">Thông số vật tư</th>
                        <th colspan="2" class="text-center" style="width: 10%;">Phương án</th>
                        <th colspan="3" class="text-center" style="width: 15%;">Khối lượng CẦN LÀM (Kế hoạch)</th>
                        <th colspan="5" class="text-center" style="width: 30%;">Tình trạng ĐÃ LÀM (Thực hiện)</th>
                        <th rowspan="3" style="width: 10%;">Ghi chú</th>
                    </tr>
                    <tr>
                        <th colspan="2" class="text-center">Kích thước danh định (mm)</th>
                        <th rowspan="2">Chiều dày thực (mm)</th>
                        <th rowspan="2">Chiều dài đoạn ống (m)</th> 
                        
                        <th rowspan="2">Phương án</th>
                        <th rowspan="2">Que hàn</th>
                        
                        <th rowspan="2">Đoạn ống</th>
                        <th rowspan="2">Tổng mối hàn</th>
                        <th rowspan="2">Số mối BP</th> 

                        <th rowspan="2">Cắt</th>
                        <th rowspan="2">Hàn mối 1</th>
                        <th rowspan="2">Hàn mối 2</th>
                        <th rowspan="2">Mối BP đã làm</th>
                        <th rowspan="2">Đoạn ống đã làm</th>
                    </tr>
                    <tr>
                        <th style="width: 4%;">Đường kính</th>
                        <th style="width: 4%;">Chiều dày</th>
                    </tr>
                </thead>
                <tbody id="data-body">
                    </tbody>
                <tfoot id="data-tfoot">
                    </tfoot>
            </table>
        </div>
    </div>

    <script>
        // DỮ LIỆU KHỞI TẠO TỔNG HỢP (totalData): ĐÃ CẬP NHẬT CHÍNH XÁC THEO FILE ẢNH MỚI NHẤT
        let totalData = [
            // 1. Quá nhiệt trung gian
            {"khuVuc": "Quá nhiệt trung gian", "soDoanOngCan": 167, "soMoiBPCan": 141, "tongMoiHanCan": 467, "soDoanOngLam": 101, "soMoiBPLam": 20, "tongMoiHanLam": 247, "ghiChu": ""},
            // 2. Quá nhiệt cấp 1
            {"khuVuc": "Quá nhiệt cấp 1", "soDoanOngCan": 97, "soMoiBPCan": 180, "tongMoiHanCan": 373, "soDoanOngLam": 80, "soMoiBPLam": 0, "tongMoiHanLam": 164, "ghiChu": ""},
            // 3. Quá nhiệt cấp 3
            {"khuVuc": "Quá nhiệt cấp 3", "soDoanOngCan": 422, "soMoiBPCan": 0, "tongMoiHanCan": 844, "soDoanOngLam": 9, "soMoiBPLam": 0, "tongMoiHanLam": 230, "ghiChu": ""},
            // 4. Bộ hâm nước
            {"khuVuc": "Bộ hâm nước", "soDoanOngCan": 115, "soMoiBPCan": 62, "tongMoiHanCan": 292, "soDoanOngLam": 67, "soMoiBPLam": 0, "tongMoiHanLam": 145, "ghiChu": ""},
            // 5. Quá nhiệt hộp: Trần
            {"khuVuc": "Quá nhiệt hộp: Trần", "soDoanOngCan": 8, "soMoiBPCan": 8, "tongMoiHanCan": 20, "soDoanOngLam": 0, "soMoiBPLam": 0, "tongMoiHanLam": 0, "ghiChu": ""},
            // 6. Ống sinh hơi (Dữ liệu trống trong file, đặt về 0)
            {"khuVuc": "Ống sinh hơi", "soDoanOngCan": 0, "soMoiBPCan": 0, "tongMoiHanCan": 0, "soDoanOngLam": 0, "soMoiBPLam": 0, "tongMoiHanLam": 0, "ghiChu": ""},
            // 7. Phục hồi giàn 82
            {"khuVuc": "Phục hồi giàn 82", "soDoanOngCan": 40, "soMoiBPCan": 63, "tongMoiHanCan": 101, "soDoanOngLam": 0, "soMoiBPLam": 42, "tongMoiHanLam": 66, "ghiChu": ""},
        ];

        let detailData = [
            // Dữ liệu chi tiết mẫu cho Quá nhiệt trung gian
            {
                "khuVuc":"Quá nhiệt trung gian", 
                "hangMuc":"TQNTG T5/ Giàn 5-1", 
                "duongKinh":50.8, 
                "chieuDayDanhDinh":4.19, 
                "chieuDayThuc":3.14,
                "chieuDaiDoanOngThayThe": 2.5, 
                "phuongAn":"Cắt thay",
                "queHanSuDung":"ER70S-6",
                "khoiLuongCanLam":1,
                "soMoiHanCanLam":2, 
                "soMoiBPCanLam":1, 
                "catLam":1,
                "hanMoi1Lam":1,
                "hanMoi2Lam":1,
                "soMoiBPLam":1,
                "soDoanOngLam":1,
                "ghiChu":"Hoàn thành"
            },
            // Dữ liệu chi tiết mẫu cho Quá nhiệt cấp 1
            {
                "khuVuc":"Quá nhiệt cấp 1", 
                "hangMuc":"TQNC1 T5/ Giàn 5-4", 
                "duongKinh":50.8, 
                "chieuDayDanhDinh":4.57, 
                "chieuDayThuc":3.4,
                "chieuDaiDoanOngThayThe": 1.2, 
                "phuongAn":"Cắt thay",
                "queHanSuDung":"ER80S-B2",
                "khoiLuongCanLam":1,
                "soMoiHanCanLam":2,
                "soMoiBPCanLam":0, 
                "catLam":1,
                "hanMoi1Lam":1,
                "hanMoi2Lam":1,
                "soMoiBPLam":0,
                "soDoanOngLam":1,
                "ghiChu":"Đã hàn xong"
            },
        ];
        let currentDetailKhuVuc = '';

        // ************************************************************
        // CHỨC NĂNG IMPORT/EXPORT (Giữ nguyên logic)
        // ************************************************************

        /** Xử lý file Kế hoạch (Plan) */
        function handlePlanUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    const newPlanData = XLSX.utils.sheet_to_json(worksheet, {
                        header: ["STT_Ignore", "khuVuc", "soDoanOngCan", "soMoiBPCan", "tongMoiHanCan"],
                        range: 2, 
                        raw: false
                    });

                    let updatedPlanData = newPlanData.filter(item => item.khuVuc).map(item => ({
                        khuVuc: item.khuVuc.trim(),
                        soDoanOngCan: parseInt(item.soDoanOngCan) || 0,
                        soMoiBPCan: parseInt(item.soMoiBPCan) || 0,
                        tongMoiHanCan: parseInt(item.tongMoiHanCan) || 0,
                        soDoanOngLam: 0, 
                        soMoiBPLam: 0,   
                        tongMoiHanLam: 0, 
                        ghiChu: ""
                    }));

                    // Cập nhật totalData: Nếu khu vực đã tồn tại, giữ nguyên "Đã làm". Nếu là khu vực mới, thêm vào.
                    totalData = updatedPlanData.map(newPlan => {
                        const existingItem = totalData.find(old => old.khuVuc === newPlan.khuVuc);
                        if (existingItem) {
                            return {
                                ...newPlan,
                                soDoanOngLam: existingItem.soDoanOngLam,
                                soMoiBPLam: existingItem.soMoiBPLam,
                                tongMoiHanLam: existingItem.tongMoiHanLam,
                                ghiChu: existingItem.ghiChu 
                            };
                        }
                        return newPlan;
                    });
                    
                    // Thêm các khu vực cũ (có dữ liệu 'đã làm') không có trong file mới vào lại
                    const existingKhuVucNames = updatedPlanData.map(item => item.khuVuc);
                    totalData.push(...totalData.filter(old => 
                        !existingKhuVucNames.includes(old.khuVuc) && (old.soDoanOngLam > 0 || old.tongMoiHanLam > 0)
                    ));


                    updateTotalDataFromDetail(); // Đồng bộ lại từ chi tiết (nếu có)
                    showTotalView();
                    alert(`Đã tải thành công và cập nhật ${totalData.length} khu vực KẾ HOẠCH!`);
                } catch (error) {
                    alert("Lỗi khi đọc file Kế hoạch. Vui lòng kiểm tra định dạng: " + error.message);
                } finally {
                    document.getElementById('plan-file-input').value = '';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        /** Xử lý file Chi tiết (Detail) */
        function handleDetailUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    const aoa = XLSX.utils.sheet_to_json(worksheet, {
                        header: 1, 
                        range: 0, 
                        raw: false, 
                        defval: "" 
                    });
                    
                    const dataRows = aoa.slice(3); 
                    
                    const khuVucHienTai = currentDetailKhuVuc;
                    let importedData = [];

                    // VỊ TRÍ CỘT ĐÃ ĐƯỢC ĐIỀU CHỈNH 
                    const COL_HANGMUC = 3;             // Cột D
                    const COL_DUONGKINH = 4;           // Cột E (Đường kính danh định)
                    const COL_CHIEUDAY_DANHDINH = 5;   // Cột F (Chiều dày danh định)
                    const COL_CHIEUDAY_THUC = 6;       // Cột G (Chiều dày thực)
                    const COL_CHIEUDAI_ONG = 7;        // Cột H (Chiều dài đoạn ống thay thế)
                    const COL_QUEHAN = 8;              // Cột I (Que hàn sử dụng)
                    const COL_PHUONGAN = 9;            // Cột J (Phương án)
                    const COL_KL_CANLAM = 10;          // Cột K (Đoạn ống cần làm)
                    const COL_MOIHAN_CANLAM = 11;      // Cột L (Tổng số mối hàn cần làm)
                    const COL_MOIBP_CANLAM = 12;       // Cột M (Số mối biện pháp cần làm)
                    const COL_CAT_LAM = 13;            // Cột N (Đã Cắt)
                    const COL_HAN1_LAM = 14;           // Cột O (Đã Hàn mối 1)
                    const COL_HAN2_LAM = 15;           // Cột P (Đã Hàn mối 2)
                    const COL_MOIBP_LAM = 16;          // Cột Q (Số mối biện pháp đã làm)
                    const COL_DOANONG_LAM = 17;        // Cột R (Số đoạn ống đã làm)
                    const COL_GHICHU = 18;             // Cột S
                    
                    const getFloat = (row, index) => {
                        const val = row[index];
                        return typeof val === 'number' ? val : (parseFloat(String(val).replace(/,/g, '.')) || 0);
                    };
                    const getInt = (row, index) => {
                        const val = row[index];
                        return typeof val === 'number' ? val : (parseInt(String(val).replace(/,/g, '.')) || 0);
                    };
                    const getString = (row, index) => (row[index] || '').trim();


                    dataRows.forEach(row => {
                        const hangMuc = getString(row, COL_HANGMUC);
                        const klCanLam = getInt(row, COL_KL_CANLAM);
                        const mhCanLam = getInt(row, COL_MOIHAN_CANLAM);

                        if (!hangMuc || (klCanLam === 0 && mhCanLam === 0)) {
                            return; 
                        }

                        importedData.push({
                            khuVuc: khuVucHienTai, 
                            hangMuc: hangMuc,
                            duongKinh: getFloat(row, COL_DUONGKINH),
                            chieuDayDanhDinh: getFloat(row, COL_CHIEUDAY_DANHDINH),
                            chieuDayThuc: getFloat(row, COL_CHIEUDAY_THUC),
                            chieuDaiDoanOngThayThe: getFloat(row, COL_CHIEUDAI_ONG),
                            phuongAn: getString(row, COL_PHUONGAN),
                            queHanSuDung: getString(row, COL_QUEHAN),
                            
                            khoiLuongCanLam: klCanLam,
                            soMoiHanCanLam: mhCanLam,
                            soMoiBPCanLam: getInt(row, COL_MOIBP_CANLAM),
                            
                            catLam: getInt(row, COL_CAT_LAM),
                            hanMoi1Lam: getInt(row, COL_HAN1_LAM),
                            hanMoi2Lam: getInt(row, COL_HAN2_LAM),
                            soMoiBPLam: getInt(row, COL_MOIBP_LAM),
                            soDoanOngLam: getInt(row, COL_DOANONG_LAM),
                            ghiChu: getString(row, COL_GHICHU)
                        });
                    });

                    // Xóa dữ liệu cũ của khu vực hiện tại và thêm dữ liệu mới
                    detailData = detailData.filter(item => item.khuVuc !== khuVucHienTai);
                    detailData.push(...importedData); 

                    updateTotalDataFromDetail(); 
                    
                    if(document.getElementById('view-detail').style.display === 'block') {
                        applyDetailFilters();
                    } else {
                        showTotalView();
                    }
                    
                    alert(`Đã tải thành công và GHI ĐÈ ${importedData.length} mục dữ liệu CHI TIẾT cho khu vực ${khuVucHienTai}!`);

                } catch (error) {
                    alert("Lỗi khi đọc file Chi tiết. Vui lòng kiểm tra định dạng, HÀNG HEADER chi tiết bắt đầu từ HÀNG SỐ 4 (index 3), và thứ tự cột: " + error.message);
                } finally {
                    document.getElementById('detail-file-input').value = '';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        /** Tải về file Chi tiết (Giữ nguyên)*/
        function downloadDataAsExcel() {
            if (detailData.length === 0) {
                alert("Không có dữ liệu chi tiết để tải về.");
                return;
            }

            const headers = [
                "Khu vực", "Hạng mục", 
                "Đường kính", "Chiều dày Danh Định", "Chiều dày Thực", "Chiều dài đoạn ống thay thế", 
                "Que hàn sử dụng", "Phương án", 
                "KL Cần làm (Đoạn ống)", "Tổng mối hàn CẦN", "Mối BP CẦN", 
                "Đã làm: Cắt", "Đã làm: Hàn mối 1", "Đã làm: Hàn mối 2", "Đã làm: Mối BP", 
                "Đã làm: Đoạn ống", "Ghi chú"
            ];
            
            const dataForExport = detailData.map(item => [
                item.khuVuc, item.hangMuc, 
                item.duongKinh, item.chieuDayDanhDinh, item.chieuDayThuc, item.chieuDaiDoanOngThayThe, 
                item.queHanSuDung, item.phuongAn, 
                item.khoiLuongCanLam, item.soMoiHanCanLam, item.soMoiBPCanLam, 
                item.catLam, item.hanMoi1Lam, item.hanMoi2Lam, item.soMoiBPLam, item.soDoanOngLam, item.ghiChu
            ]);

            const ws = XLSX.utils.aoa_to_sheet([headers, ...dataForExport]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "DuLieuChiTiet");

            XLSX.writeFile(wb, "DuLieuChiTiet_DaiTuLo1_" + new Date().toISOString().slice(0, 10) + ".xlsx");
        }

        // ************************************************************
        // CÁC HÀM XỬ LÝ DỮ LIỆU & GIAO DIỆN (Giữ nguyên logic)
        // ************************************************************
        
        /** Cập nhật dữ liệu tổng hợp từ dữ liệu chi tiết */
        function updateTotalDataFromDetail() {
            const planMapFromDetail = {};
            const summaryMapFromDetail = {};

            // 1. Tính toán lại kế hoạch và thực hiện từ dữ liệu chi tiết
            detailData.forEach(item => {
                const khuVuc = item.khuVuc.trim();
                
                if (!planMapFromDetail[khuVuc]) {
                    planMapFromDetail[khuVuc] = { soDoanOngCan: 0, soMoiBPCan: 0, tongMoiHanCan: 0 };
                    summaryMapFromDetail[khuVuc] = { soDoanOngLam: 0, soMoiBPLam: 0, tongMoiHanLam: 0 };
                }
                
                // Kế hoạch (Can)
                planMapFromDetail[khuVuc].soDoanOngCan += parseInt(item.khoiLuongCanLam || 0);
                planMapFromDetail[khuVuc].soMoiBPCan += parseInt(item.soMoiBPCanLam || 0); 
                planMapFromDetail[khuVuc].tongMoiHanCan += parseInt(item.soMoiHanCanLam || 0);

                // Đã làm (Lam)
                summaryMapFromDetail[khuVuc].soDoanOngLam += parseInt(item.soDoanOngLam || 0);
                summaryMapFromDetail[khuVuc].soMoiBPLam += parseInt(item.soMoiBPLam || 0);
                
                // Tổng mối hàn đã làm = Cắt + Hàn mối 1 + Hàn mối 2 (Nếu có mối 3 thì cộng thêm, hiện tại đang dùng 3 cột thực hiện cho 3 bước chính)
                summaryMapFromDetail[khuVuc].tongMoiHanLam += parseInt(item.catLam || 0) + parseInt(item.hanMoi1Lam || 0) + parseInt(item.hanMoi2Lam || 0); 
            });

            const newTotalData = [];
            
            // 2. Gom tất cả khu vực từ cả 2 nguồn: totalData cũ và detailData mới
            const allKhuVuc = new Set([...totalData.map(item => item.khuVuc), ...Object.keys(planMapFromDetail)]);

            // 3. Xây dựng lại totalData
            allKhuVuc.forEach(khuVuc => {
                const existingItem = totalData.find(old => old.khuVuc === khuVuc);
                const summary = summaryMapFromDetail[khuVuc] || { soDoanOngLam: 0, soMoiBPLam: 0, tongMoiHanLam: 0 };
                const planFromDetail = planMapFromDetail[khuVuc];
                
                let updatedItem = { 
                    khuVuc: khuVuc, 
                    ghiChu: (existingItem ? existingItem.ghiChu : '') || '' 
                };
                
                // Ưu tiên Kế hoạch từ file Kế hoạch tổng (nếu không có Kế hoạch chi tiết)
                if (existingItem && (existingItem.soDoanOngCan > 0 || existingItem.tongMoiHanCan > 0)) {
                    updatedItem.soDoanOngCan = existingItem.soDoanOngCan;
                    updatedItem.soMoiBPCan = existingItem.soMoiBPCan;
                    updatedItem.tongMoiHanCan = existingItem.tongMoiHanCan;
                } 
                // Nếu không có trong file tổng, lấy từ tổng hợp chi tiết
                else if (planFromDetail) {
                    updatedItem.soDoanOngCan = planFromDetail.soDoanOngCan;
                    updatedItem.soMoiBPCan = planFromDetail.soMoiBPCan;
                    updatedItem.tongMoiHanCan = planFromDetail.tongMoiHanCan;
                } else {
                    // Khu vực có trong old totalData nhưng kế hoạch bằng 0 và không có trong detail, giữ nguyên 0
                    updatedItem.soDoanOngCan = 0;
                    updatedItem.soMoiBPCan = 0;
                    updatedItem.tongMoiHanCan = 0;
                }

                // Luôn lấy dữ liệu Đã làm từ tổng hợp Chi tiết
                updatedItem.soDoanOngLam = summary.soDoanOngLam;
                updatedItem.soMoiBPLam = summary.soMoiBPLam;
                updatedItem.tongMoiHanLam = summary.tongMoiHanLam;

                newTotalData.push(updatedItem);
            });

            totalData = newTotalData;
        }
        
        function showTotalView() {
            document.getElementById('view-total').style.display = 'block';
            document.getElementById('view-detail').style.display = 'none';
            currentDetailKhuVuc = '';
            document.getElementById('filterHangMuc').value = '';
            renderTotalTable();
        }

        function showDetailView(khuVuc) {
            currentDetailKhuVuc = khuVuc;
            document.getElementById('detail-header').textContent = `Chi Tiết & Cập Nhật: ${khuVuc}`;
            document.getElementById('current-khuVuc-update').textContent = khuVuc;
            document.getElementById('khuVuc').value = khuVuc;
            
            document.getElementById('view-total').style.display = 'none';
            document.getElementById('view-detail').style.display = 'block';
            
            resetInputForm();
            applyDetailFilters();
        }

        function renderTotalTable() {
            const tableBody = document.getElementById('total-data-body');
            tableBody.innerHTML = ''; 

            const dataToRender = totalData.sort((a, b) => a.khuVuc.localeCompare(b.khuVuc));
            
            let totalCanOng = 0, totalCanBP = 0, totalCanHan = 0;
            let totalLamOng = 0, totalLamBP = 0, totalLamHan = 0;

            dataToRender.forEach(item => {
                const canOng = item.soDoanOngCan;
                const canBP = item.soMoiBPCan;
                const canHan = item.tongMoiHanCan;
                
                const lamOng = item.soDoanOngLam;
                const lamBP = item.soMoiBPLam;
                const lamHan = item.tongMoiHanLam;

                const conOng = canOng - lamOng;
                const conBP = canBP - lamBP;
                const conHan = canHan - lamHan;
                
                const percentOng = canOng > 0 ? (lamOng / canOng) * 100 : (lamOng > 0 ? 100 : 0);
                const percentHan = canHan > 0 ? (lamHan / canHan) * 100 : (lamHan > 0 ? 100 : 0);

                totalCanOng += canOng;
                totalCanBP += canBP;
                totalCanHan += canHan;
                totalLamOng += lamOng;
                totalLamBP += lamBP;
                totalLamHan += lamHan;

                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td onclick="showDetailView('${item.khuVuc}')" style="font-weight: bold; color: #007bff; cursor: pointer;">${item.khuVuc}</td>
                    <td class="text-center">${canOng}</td>
                    <td class="text-center">${canBP}</td>
                    <td class="text-center">${canHan}</td>
                    <td class="text-center" style="background-color: #d4edda;">${lamOng}</td>
                    <td class="text-center" style="background-color: #d4edda;">${lamBP}</td>
                    <td class="text-center" style="background-color: #d4edda;">${lamHan}</td>
                    <td class="text-center">${Math.max(0, conOng)}</td>
                    <td class="text-center">${Math.max(0, conBP)}</td>
                    <td class="text-center">${Math.max(0, conHan)}</td>
                    <td class="text-center" style="background-color: ${percentOng >= 100 ? '#28a745' : percentOng > 0 ? '#ffc107' : '#f8d7da'}; color: ${percentOng >= 100 ? 'white' : 'black'};">${percentOng.toFixed(2)}%</td>
                    <td class="text-center" style="background-color: ${percentHan >= 100 ? '#28a745' : percentHan > 0 ? '#ffc107' : '#f8d7da'}; color: ${percentHan >= 100 ? 'white' : 'black'};">${percentHan.toFixed(2)}%</td>
                    <td>${item.ghiChu}</td>
                `;
            });

            // Thêm dòng tổng cộng
            const totalPercentOng = totalCanOng > 0 ? (totalLamOng / totalCanOng) * 100 : (totalLamOng > 0 ? 100 : 0);
            const totalPercentHan = totalCanHan > 0 ? (totalLamHan / totalCanHan) * 100 : (totalLamHan > 0 ? 100 : 0);

            const totalRow = tableBody.insertRow();
            totalRow.style.fontWeight = 'bold';
            totalRow.style.backgroundColor = '#f0f0f0';
            totalRow.innerHTML = `
                <td style="text-align: center;">TỔNG CỘNG</td>
                <td class="text-center">${totalCanOng}</td>
                <td class="text-center">${totalCanBP}</td>
                <td class="text-center">${totalCanHan}</td>
                <td class="text-center" style="background-color: #c3e6cb;">${totalLamOng}</td>
                <td class="text-center" style="background-color: #c3e6cb;">${totalLamBP}</td>
                <td class="text-center" style="background-color: #c3e6cb;">${totalLamHan}</td>
                <td class="text-center">${Math.max(0, totalCanOng - totalLamOng)}</td>
                <td class="text-center">${Math.max(0, totalCanBP - totalLamBP)}</td>
                <td class="text-center">${Math.max(0, totalCanHan - totalLamHan)}</td>
                <td class="text-center" style="background-color: ${totalPercentOng >= 100 ? '#1e7e34' : totalPercentOng > 0 ? '#d39e00' : '#c63832'}; color: white;">${totalPercentOng.toFixed(2)}%</td>
                <td class="text-center" style="background-color: ${totalPercentHan >= 100 ? '#1e7e34' : totalPercentHan > 0 ? '#d39e00' : '#c63832'}; color: white;">${totalPercentHan.toFixed(2)}%</td>
                <td></td>
            `;
        }

        function renderDetailTable(filteredData) {
            const tableBody = document.getElementById('data-body');
            const tableFoot = document.getElementById('data-tfoot');
            tableBody.innerHTML = ''; 
            tableFoot.innerHTML = '';

            let totalCanOng = 0, totalCanHan = 0, totalCanBP = 0;
            let totalLamCat = 0, totalLamHan1 = 0, totalLamHan2 = 0, totalLamBP = 0, totalLamOng = 0;
            let sttCounter = 1;

            filteredData.forEach(item => {
                const row = tableBody.insertRow();
                row.setAttribute('data-hangmuc', item.hangMuc);
                row.onclick = () => fillFormForUpdate(item);
                
                // Tính tổng
                totalCanOng += item.khoiLuongCanLam;
                totalCanHan += item.soMoiHanCanLam;
                totalCanBP += item.soMoiBPCanLam;
                totalLamCat += item.catLam;
                totalLamHan1 += item.hanMoi1Lam;
                totalLamHan2 += item.hanMoi2Lam;
                totalLamBP += item.soMoiBPLam;
                totalLamOng += item.soDoanOngLam;

                // Render dữ liệu
                row.innerHTML = `
                    <td class="text-center">${sttCounter++}</td>
                    <td>${item.hangMuc}</td>
                    <td class="text-center">${item.duongKinh}</td>
                    <td class="text-center">${item.chieuDayDanhDinh}</td>
                    <td class="text-center">${item.chieuDayThuc}</td>
                    <td class="text-center">${item.chieuDaiDoanOngThayThe || ''}</td>
                    <td>${item.phuongAn}</td>
                    <td>${item.queHanSuDung}</td>
                    <td class="text-center" style="font-weight: bold; background-color: #fff3cd;">${item.khoiLuongCanLam}</td>
                    <td class="text-center" style="font-weight: bold; background-color: #fff3cd;">${item.soMoiHanCanLam}</td>
                    <td class="text-center" style="font-weight: bold; background-color: #fff3cd;">${item.soMoiBPCanLam}</td>
                    <td class="text-center">${item.catLam}</td>
                    <td class="text-center">${item.hanMoi1Lam}</td>
                    <td class="text-center">${item.hanMoi2Lam}</td>
                    <td class="text-center">${item.soMoiBPLam}</td>
                    <td class="text-center" style="font-weight: bold; background-color: #d4edda;">${item.soDoanOngLam}</td>
                    <td>${item.ghiChu}</td>
                `;
            });
            
            // Cập nhật STT cho lần nhập tiếp theo
            document.getElementById('stt').value = sttCounter;


            // Dòng tổng cộng chi tiết
            const totalRow = tableFoot.insertRow();
            totalRow.style.fontWeight = 'bold';
            totalRow.style.backgroundColor = '#e9ecef';
            totalRow.innerHTML = `
                <td colspan="8" style="text-align: center;">TỔNG CỘNG KHU VỰC ${currentDetailKhuVuc}</td>
                <td class="text-center">${totalCanOng}</td>
                <td class="text-center">${totalCanHan}</td>
                <td class="text-center">${totalCanBP}</td>
                <td class="text-center">${totalLamCat}</td>
                <td class="text-center">${totalLamHan1}</td>
                <td class="text-center">${totalLamHan2}</td>
                <td class="text-center">${totalLamBP}</td>
                <td class="text-center">${totalLamOng}</td>
                <td></td>
            `;

            // Cập nhật lại totalData sau khi tính toán tổng chi tiết
            const totalItem = totalData.find(item => item.khuVuc === currentDetailKhuVuc);
            if(totalItem) {
                totalItem.soDoanOngLam = totalLamOng;
                totalItem.soMoiBPLam = totalLamBP;
                // Cập nhật lại cột 'Tổng mối hàn đã làm' trong totalData
                totalItem.tongMoiHanLam = totalLamCat + totalLamHan1 + totalLamHan2; 
                
                // Nếu kế hoạch trong totalData là 0 (đã reset), thì cập nhật từ chi tiết
                if(totalItem.soDoanOngCan === 0 && totalItem.tongMoiHanCan === 0) {
                    totalItem.soDoanOngCan = totalCanOng;
                    totalItem.soMoiBPCan = totalCanBP;
                    totalItem.tongMoiHanCan = totalCanHan;
                }
            }
        }

        function applyDetailFilters() {
            const filterValue = document.getElementById('filterHangMuc').value.toLowerCase();
            const filteredData = detailData.filter(item => 
                item.khuVuc === currentDetailKhuVuc && 
                (item.hangMuc.toLowerCase().includes(filterValue) || item.ghiChu.toLowerCase().includes(filterValue))
            );
            renderDetailTable(filteredData);
        }

        function getFormData() {
            return {
                khuVuc: document.getElementById('khuVuc').value.trim(),
                hangMuc: document.getElementById('hangMuc').value.trim(),
                duongKinh: parseFloat(document.getElementById('duongKinh').value) || 0,
                chieuDayDanhDinh: parseFloat(document.getElementById('chieuDayDanhDinh').value) || 0,
                chieuDayThuc: parseFloat(document.getElementById('chieuDayThuc').value) || 0,
                chieuDaiDoanOngThayThe: parseFloat(document.getElementById('chieuDaiDoanOngThayThe').value) || 0,
                phuongAn: document.getElementById('phuongAn').value.trim(),
                queHanSuDung: document.getElementById('queHanSuDung').value.trim(),
                
                // Kế hoạch (Can)
                khoiLuongCanLam: parseInt(document.getElementById('khoiLuongCanLam').value) || 0,
                soMoiHanCanLam: parseInt(document.getElementById('soMoiHanCanLam').value) || 0,
                soMoiBPCanLam: parseInt(document.getElementById('soMoiBPCanLam').value) || 0, 

                // Thực hiện (Lam)
                catLam: parseInt(document.getElementById('catLam').value) || 0,
                hanMoi1Lam: parseInt(document.getElementById('hanMoi1Lam').value) || 0,
                hanMoi2Lam: parseInt(document.getElementById('hanMoi2Lam').value) || 0, 
                soMoiBPLam: parseInt(document.getElementById('soMoiBPLam').value) || 0,
                soDoanOngLam: parseInt(document.getElementById('soDoanOngLam').value) || 0,
                
                ghiChu: document.getElementById('ghiChu').value.trim(),
            };
        }

        function resetInputForm() {
            document.getElementById('stt').value = (detailData.filter(item => item.khuVuc === currentDetailKhuVuc).length + 1) || 1;
            document.getElementById('hangMuc').value = '';
            document.getElementById('duongKinh').value = '50.80';
            document.getElementById('chieuDayDanhDinh').value = '4.57';
            document.getElementById('chieuDayThuc').value = '';
            document.getElementById('chieuDaiDoanOngThayThe').value = '';
            document.getElementById('phuongAn').value = 'Cắt thay';
            document.getElementById('queHanSuDung').value = 'ER80S-B2';
            
            document.getElementById('khoiLuongCanLam').value = '1';
            document.getElementById('soMoiHanCanLam').value = '2';
            document.getElementById('soMoiBPCanLam').value = '0';
            
            document.getElementById('catLam').value = '0';
            document.getElementById('hanMoi1Lam').value = '0';
            document.getElementById('hanMoi2Lam').value = '0';
            document.getElementById('soMoiBPLam').value = '0';
            document.getElementById('soDoanOngLam').value = '0';
            
            document.getElementById('ghiChu').value = '';
            document.getElementById('add-row-btn').textContent = 'Thêm Mới / Cập Nhật Tiến Độ';
            document.getElementById('add-row-btn').dataset.editingIndex = '';
        }

        function fillFormForUpdate(item) {
            document.getElementById('stt').value = 'CẬP NHẬT'; // Đánh dấu đang sửa
            document.getElementById('hangMuc').value = item.hangMuc;
            document.getElementById('duongKinh').value = item.duongKinh;
            document.getElementById('chieuDayDanhDinh').value = item.chieuDayDanhDinh;
            document.getElementById('chieuDayThuc').value = item.chieuDayThuc;
            document.getElementById('chieuDaiDoanOngThayThe').value = item.chieuDaiDoanOngThayThe;
            document.getElementById('phuongAn').value = item.phuongAn;
            document.getElementById('queHanSuDung').value = item.queHanSuDung;
            
            document.getElementById('khoiLuongCanLam').value = item.khoiLuongCanLam;
            document.getElementById('soMoiHanCanLam').value = item.soMoiHanCanLam;
            document.getElementById('soMoiBPCanLam').value = item.soMoiBPCanLam;
            
            document.getElementById('catLam').value = item.catLam;
            document.getElementById('hanMoi1Lam').value = item.hanMoi1Lam;
            document.getElementById('hanMoi2Lam').value = item.hanMoi2Lam;
            document.getElementById('soMoiBPLam').value = item.soMoiBPLam;
            document.getElementById('soDoanOngLam').value = item.soDoanOngLam;

            document.getElementById('ghiChu').value = item.ghiChu;
            document.getElementById('add-row-btn').textContent = `Cập Nhật Cho Hạng Mục: ${item.hangMuc}`;
            
            // Tìm index của mục đang được chọn
            const index = detailData.findIndex(d => 
                d.khuVuc === item.khuVuc && 
                d.hangMuc === item.hangMuc && 
                d.khoiLuongCanLam === item.khoiLuongCanLam 
            );
            document.getElementById('add-row-btn').dataset.editingIndex = index;
        }


        function handleAddOrUpdateRow() {
            const formData = getFormData();

            if (!formData.hangMuc) {
                alert('Vui lòng nhập Hạng mục.');
                return;
            }

            const editingIndex = document.getElementById('add-row-btn').dataset.editingIndex;
            
            const existingItemIndex = detailData.findIndex(item => 
                item.khuVuc === formData.khuVuc && 
                item.hangMuc === formData.hangMuc
            );

            if (existingItemIndex !== -1 && editingIndex === '') {
                 // Nếu hạng mục đã tồn tại và không phải chế độ sửa
                 const isConfirm = confirm(`Hạng mục "${formData.hangMuc}" đã tồn tại. Bạn muốn CẬP NHẬT tiến độ cho hạng mục này không? (Nếu muốn thêm mới, vui lòng đổi tên Hạng mục)`);
                 if(isConfirm) {
                    detailData[existingItemIndex] = formData;
                 } else {
                     return;
                 }
            } else if (editingIndex !== '') {
                // Chế độ CẬP NHẬT
                detailData[editingIndex] = formData;
            } else {
                // Chế độ THÊM MỚI
                detailData.push(formData);
            }
            
            // Sau khi thay đổi, reset form, cập nhật bảng chi tiết và bảng tổng
            resetInputForm();
            updateTotalDataFromDetail();
            applyDetailFilters();
        }

        // Khởi tạo các sự kiện
        document.getElementById('add-row-btn').addEventListener('click', handleAddOrUpdateRow);

        // Khởi tạo ứng dụng
        document.addEventListener('DOMContentLoaded', () => {
            updateTotalDataFromDetail();
            showTotalView();
        });

    </script>
</body>
</html><!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QUẢN LÝ TIẾN ĐỘ SỬA CHỮA ĐẠI TU ỐNG LÒ SỐ 1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        /* CSS (Giữ nguyên) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #e9ecef;
            color: #333;
        }
        #main-header {
            background-color: #004085;
            color: white;
            padding: 20px 20px;
            font-size: 26px;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        #content-area {
            padding: 20px;
        }
        h2 {
            color: #0056b3;
            border-bottom: 2px solid #0056b3;
            padding-bottom: 8px;
            margin-top: 30px;
            font-size: 20px;
        }
        .file-management-section {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        #file-management-detail, #file-management-plan {
             border-left: 5px solid #17a2b8; 
        }
        #file-management-plan {
            border-left: 5px solid #ffc107; 
        }
        .upload-label, .download-btn, #plan-upload-label {
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            border: none;
        }
        #detail-upload-label, #detail-upload-label-in-detail {
            background-color: #28a745; 
            color: white;
        }
        #detail-upload-label:hover, #detail-upload-label-in-detail:hover {
            background-color: #1e7e34;
        }
        .download-btn {
            background-color: #007bff; 
            color: white;
        }
        .download-btn:hover {
            background-color: #0056b3;
        }
        #plan-upload-label {
            background-color: #ffc107; 
            color: #343a3d;
        }
        #plan-upload-label:hover {
            background-color: #e0a800;
        }
        .excel-file-input {
            display: none;
        }
        #input-form {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            border-left: 5px solid #dc3545; 
        }
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .form-group {
            flex: 1 1 150px; 
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 3px;
            color: #0056b3;
        }
        .form-group input, .form-group select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
            box-sizing: border-box;
        }
        .form-group.full-width {
            flex: 1 1 100%;
        }
        .button-group {
            flex: 1 1 200px;
            justify-content: flex-end;
        }
        #add-row-btn {
            background-color: #dc3545;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            table-layout: fixed;
        }
        #total-data-table {
            table-layout: auto; 
        }
        th, td {
            border: 1px solid #cce5ff;
            padding: 8px 5px; 
            text-align: left;
            font-size: 12px; 
            vertical-align: top;
            word-wrap: break-word;
        }
        th {
            background-color: #0056b3;
            color: white;
            font-weight: bold;
            text-align: center;
            border-color: #004085;
        }
        #data-table thead tr:nth-child(2) th {
            background-color: #4CAF50;
            color: white;
            font-weight: normal;
        }
        #data-table thead tr:nth-child(3) th {
            background-color: #6c757d;
            color: white;
            font-weight: normal;
        }
        .text-center { text-align: center; }
        .back-button {
            background-color: #6c757d;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 20px;
            display: inline-block;
        }
        #total-data-body tr:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="main-header">QUẢN LÝ TIẾN ĐỘ SỬA CHỮA ĐẠI TU ỐNG LÒ SỐ 1</div>

    <div id="content-area">

        <div id="view-total">
            <h2>Tiến Độ Tổng Hợp Toàn Bộ Công Việc</h2>
            <table id="total-data-table">
                <thead>
                    <tr>
                        <th rowspan="2" style="width: 15%;">Khu vực</th>
                        <th colspan="3" class="text-center">Khối lượng cần làm (Kế hoạch)</th>
                        <th colspan="3" class="text-center">Khối lượng đã làm (Thực hiện)</th>
                        <th colspan="3" class="text-center">Khối lượng còn lại</th>
                        <th colspan="2" class="text-center">% Hoàn thành</th>
                        <th rowspan="2" style="width: 10%;">Ghi chú</th>
                    </tr>
                    <tr>
                        <th style="width: 5%;">Số đoạn ống</th>
                        <th style="width: 5%;">Số mối biện pháp</th>
                        <th style="width: 7%;">Tổng số mối hàn</th>
                        <th style="width: 5%;">Số đoạn ống</th>
                        <th style="width: 5%;">Số mối biện pháp</th>
                        <th style="width: 7%;">Tổng số mối hàn</th>
                        <th style="width: 5%;">Số đoạn ống</th>
                        <th style="width: 5%;">Số mối biện pháp</th>
                        <th style="width: 7%;">Tổng số mối hàn</th>
                        <th style="width: 8%;">Theo Đoạn Ống</th>
                        <th style="width: 8%;">Theo Mối Hàn</th>
                    </tr>
                </thead>
                <tbody id="total-data-body">
                    </tbody>
            </table>
            <p style="margin-top: 20px; font-style: italic; color: #5a6268;">* Click vào tên **Khu vực** trong bảng để xem chi tiết, tìm kiếm và cập nhật tiến độ.</p>
        </div>

        <div id="hidden-file-management" style="display: none;">
            
            <h2>Quản Lý Dữ Liệu Kế Hoạch (CẦN LÀM)</h2>
            <div id="file-management-plan" class="file-management-section">
                <input type="file" id="plan-file-input" class="excel-file-input" accept=".xlsx, .xls, .csv" onchange="handlePlanUpload(event)">
                <label for="plan-file-input" id="plan-upload-label">
                    &#x2191; Cập nhật File KẾ HOẠCH TỔNG (.xlsx, .csv)
                </label>
                <span style="font-size: 12px; color: #6c757d;">(File Excel/CSV phải có 4 cột: Khu vực, Số đoạn ống cần, Số mối BP cần, Tổng mối hàn cần)</span>
            </div>
        </div>

        <div id="view-detail" style="display: none;">
            <button class="back-button" onclick="showTotalView()">&#9664; Trở về Bảng Tổng Hợp</button>

            <h2 id="detail-header"></h2>

            <h2>Quản Lý File Dữ Liệu Chi Tiết</h2>
            <div id="file-management-detail" class="file-management-section">
                <input type="file" id="detail-file-input" class="excel-file-input" accept=".xlsx, .xls, .csv" onchange="handleDetailUpload(event)">
                <label for="detail-file-input" id="detail-upload-label-in-detail" class="upload-label">
                    &#x2191; **Upload/Ghi đè** File DỮ LIỆU CHI TIẾT (.xlsx, .csv)
                </label>
                
                <button class="download-btn" onclick="downloadDataAsExcel()">
                    &#x2193; Tải về File DỮ LIỆU CHI TIẾT hiện tại (.xlsx)
                </button>
                <span style="font-size: 12px; color: #6c757d;">*Lưu ý: Upload mới sẽ thay thế toàn bộ dữ liệu chi tiết hiện có.</span>
            </div>


            <h2>Tìm Kiếm & Tra Cứu Dữ Liệu Chi Tiết</h2>
            <div id="filter-section" style="border-left: 5px solid #ffc107; padding: 15px; background-color: #fff; margin-bottom: 20px;">
                <div class="form-row">
                    <div class="form-group" style="flex: 1 1 100%;">
                        <label for="filterHangMuc">Lọc theo Hạng mục (Gõ để tìm kiếm)</label>
                        <input type="text" id="filterHangMuc" placeholder="Nhập hạng mục..." onkeyup="applyDetailFilters()">
                    </div>
                </div>
            </div>

            <h2>Nhập/Cập Nhật Dữ Liệu (<span id="current-khuVuc-update" style="color: #dc3545; font-weight: bold;"></span>)</h2>
            <div id="input-form">
                <div class="form-row">
                    <div class="form-group"><label for="stt">STT tiếp theo</label><input type="number" id="stt" value="1" readonly style="background-color: #fff3cd;"></div>
                    <div class="form-group"><label for="khuVuc">Khu vực</label><input type="text" id="khuVuc" required readonly style="background-color: #eee;"></div>
                    <div class="form-group"><label for="hangMuc">Hạng mục **(BẮT BUỘC)**</label><input type="text" id="hangMuc" value="" required></div>
                    <div class="form-group"><label for="duongKinh">Đường kính D.D. (mm)</label><input type="number" step="0.01" id="duongKinh" value="50.80"></div>
                    <div class="form-group"><label for="chieuDayDanhDinh">Chiều dày D.D. (mm)</label><input type="number" step="0.01" id="chieuDayDanhDinh" value="4.57"></div>
                </div>
                
                <div class="form-row">
                    <div class="form-group"><label for="chieuDayThuc">Chiều dày THỰC (mm)</label><input type="number" step="0.01" id="chieuDayThuc" value="3.41"></div>
                    <div class="form-group"><label for="chieuDaiDoanOngThayThe">Chiều dài đoạn ống thay thế (m)</label><input type="number" step="0.01" id="chieuDaiDoanOngThayThe" value=""></div> 
                    <div class="form-group"><label for="queHanSuDung">Que hàn sử dụng</label><input type="text" id="queHanSuDung" value="ER80S-B2"></div>
                    <div class="form-group"><label for="phuongAn">Phương án</label><select id="phuongAn">
                        <option value="Cắt thay" selected>Cắt thay</option>
                        <option value="Hàn đắp">Hàn đắp</option>
                        <option value="Phục hồi">Phục hồi</option>
                        <option value="Khác">Khác</option>
                    </select></div>
                </div>

                <div class="form-row" style="border-top: 1px dashed #ccc; padding-top: 10px;">
                    <div class="form-group"><label for="khoiLuongCanLam">KL Cần làm (Đoạn ống)</label><input type="number" step="1" id="khoiLuongCanLam" value="1"></div>
                    <div class="form-group"><label for="soMoiHanCanLam">Tổng số mối hàn CẦN</label><input type="number" step="1" id="soMoiHanCanLam" value="2"></div>
                    <div class="form-group"><label for="soMoiBPCanLam">Số mối BP CẦN</label><input type="number" step="1" id="soMoiBPCanLam" value="0"></div> 
                </div>

                <div class="form-row" style="border-top: 1px dashed #ccc; padding-top: 10px;">
                    <div class="form-group"><label for="catLam">Đã làm: Cắt</label><input type="number" id="catLam" value="0"></div>
                    <div class="form-group"><label for="hanMoi1Lam">Đã làm: Hàn mối 1</label><input type="number" id="hanMoi1Lam" value="0"></div>
                    <div class="form-group"><label for="hanMoi2Lam">Đã làm: Hàn mối 2</label><input type="number" id="hanMoi2Lam" value="0"></div> 
                    <div class="form-group"><label for="soMoiBPLam">Đã làm: Số mối BP</label><input type="number" id="soMoiBPLam" value="0"></div>
                    <div class="form-group"><label for="soDoanOngLam">Đã làm: Số đoạn ống</label><input type="number" id="soDoanOngLam" value="0"></div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width"><label for="ghiChu">Ghi chú</label><input type="text" id="ghiChu"></div>
                </div>
                
                <div class="form-row">
                    <div class="form-group button-group full-width">
                        <button id="add-row-btn">Thêm Mới / Cập Nhật Tiến Độ</button>
                    </div>
                </div>
            </div>

            <h2>Bảng Chi Tiết Dữ Liệu (Đã Lọc theo Khu vực)</h2>
            <table id="data-table">
                <thead>
                    <tr>
                        <th rowspan="3" style="width: 3%;">STT</th>
                        <th rowspan="3" style="width: 15%;">Hạng mục (Khu vực)</th>
                        <th colspan="4" class="text-center" style="width: 20%;">Thông số vật tư</th>
                        <th colspan="2" class="text-center" style="width: 10%;">Phương án</th>
                        <th colspan="3" class="text-center" style="width: 15%;">Khối lượng CẦN LÀM (Kế hoạch)</th>
                        <th colspan="5" class="text-center" style="width: 30%;">Tình trạng ĐÃ LÀM (Thực hiện)</th>
                        <th rowspan="3" style="width: 10%;">Ghi chú</th>
                    </tr>
                    <tr>
                        <th colspan="2" class="text-center">Kích thước danh định (mm)</th>
                        <th rowspan="2">Chiều dày thực (mm)</th>
                        <th rowspan="2">Chiều dài đoạn ống (m)</th> 
                        
                        <th rowspan="2">Phương án</th>
                        <th rowspan="2">Que hàn</th>
                        
                        <th rowspan="2">Đoạn ống</th>
                        <th rowspan="2">Tổng mối hàn</th>
                        <th rowspan="2">Số mối BP</th> 

                        <th rowspan="2">Cắt</th>
                        <th rowspan="2">Hàn mối 1</th>
                        <th rowspan="2">Hàn mối 2</th>
                        <th rowspan="2">Mối BP đã làm</th>
                        <th rowspan="2">Đoạn ống đã làm</th>
                    </tr>
                    <tr>
                        <th style="width: 4%;">Đường kính</th>
                        <th style="width: 4%;">Chiều dày</th>
                    </tr>
                </thead>
                <tbody id="data-body">
                    </tbody>
                <tfoot id="data-tfoot">
                    </tfoot>
            </table>
        </div>
    </div>

    <script>
        // DỮ LIỆU KHỞI TẠO TỔNG HỢP (totalData): ĐÃ CẬP NHẬT CHÍNH XÁC THEO FILE ẢNH MỚI NHẤT
        let totalData = [
            // 1. Quá nhiệt trung gian
            {"khuVuc": "Quá nhiệt trung gian", "soDoanOngCan": 167, "soMoiBPCan": 141, "tongMoiHanCan": 467, "soDoanOngLam": 101, "soMoiBPLam": 20, "tongMoiHanLam": 247, "ghiChu": ""},
            // 2. Quá nhiệt cấp 1
            {"khuVuc": "Quá nhiệt cấp 1", "soDoanOngCan": 97, "soMoiBPCan": 180, "tongMoiHanCan": 373, "soDoanOngLam": 80, "soMoiBPLam": 0, "tongMoiHanLam": 164, "ghiChu": ""},
            // 3. Quá nhiệt cấp 3
            {"khuVuc": "Quá nhiệt cấp 3", "soDoanOngCan": 422, "soMoiBPCan": 0, "tongMoiHanCan": 844, "soDoanOngLam": 9, "soMoiBPLam": 0, "tongMoiHanLam": 230, "ghiChu": ""},
            // 4. Bộ hâm nước
            {"khuVuc": "Bộ hâm nước", "soDoanOngCan": 115, "soMoiBPCan": 62, "tongMoiHanCan": 292, "soDoanOngLam": 67, "soMoiBPLam": 0, "tongMoiHanLam": 145, "ghiChu": ""},
            // 5. Quá nhiệt hộp: Trần
            {"khuVuc": "Quá nhiệt hộp: Trần", "soDoanOngCan": 8, "soMoiBPCan": 8, "tongMoiHanCan": 20, "soDoanOngLam": 0, "soMoiBPLam": 0, "tongMoiHanLam": 0, "ghiChu": ""},
            // 6. Ống sinh hơi (Dữ liệu trống trong file, đặt về 0)
            {"khuVuc": "Ống sinh hơi", "soDoanOngCan": 0, "soMoiBPCan": 0, "tongMoiHanCan": 0, "soDoanOngLam": 0, "soMoiBPLam": 0, "tongMoiHanLam": 0, "ghiChu": ""},
            // 7. Phục hồi giàn 82
            {"khuVuc": "Phục hồi giàn 82", "soDoanOngCan": 40, "soMoiBPCan": 63, "tongMoiHanCan": 101, "soDoanOngLam": 0, "soMoiBPLam": 42, "tongMoiHanLam": 66, "ghiChu": ""},
        ];

        let detailData = [
            // Dữ liệu chi tiết mẫu cho Quá nhiệt trung gian
            {
                "khuVuc":"Quá nhiệt trung gian", 
                "hangMuc":"TQNTG T5/ Giàn 5-1", 
                "duongKinh":50.8, 
                "chieuDayDanhDinh":4.19, 
                "chieuDayThuc":3.14,
                "chieuDaiDoanOngThayThe": 2.5, 
                "phuongAn":"Cắt thay",
                "queHanSuDung":"ER70S-6",
                "khoiLuongCanLam":1,
                "soMoiHanCanLam":2, 
                "soMoiBPCanLam":1, 
                "catLam":1,
                "hanMoi1Lam":1,
                "hanMoi2Lam":1,
                "soMoiBPLam":1,
                "soDoanOngLam":1,
                "ghiChu":"Hoàn thành"
            },
            // Dữ liệu chi tiết mẫu cho Quá nhiệt cấp 1
            {
                "khuVuc":"Quá nhiệt cấp 1", 
                "hangMuc":"TQNC1 T5/ Giàn 5-4", 
                "duongKinh":50.8, 
                "chieuDayDanhDinh":4.57, 
                "chieuDayThuc":3.4,
                "chieuDaiDoanOngThayThe": 1.2, 
                "phuongAn":"Cắt thay",
                "queHanSuDung":"ER80S-B2",
                "khoiLuongCanLam":1,
                "soMoiHanCanLam":2,
                "soMoiBPCanLam":0, 
                "catLam":1,
                "hanMoi1Lam":1,
                "hanMoi2Lam":1,
                "soMoiBPLam":0,
                "soDoanOngLam":1,
                "ghiChu":"Đã hàn xong"
            },
        ];
        let currentDetailKhuVuc = '';

        // ************************************************************
        // CHỨC NĂNG IMPORT/EXPORT (Giữ nguyên logic)
        // ************************************************************

        /** Xử lý file Kế hoạch (Plan) */
        function handlePlanUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    const newPlanData = XLSX.utils.sheet_to_json(worksheet, {
                        header: ["STT_Ignore", "khuVuc", "soDoanOngCan", "soMoiBPCan", "tongMoiHanCan"],
                        range: 2, 
                        raw: false
                    });

                    let updatedPlanData = newPlanData.filter(item => item.khuVuc).map(item => ({
                        khuVuc: item.khuVuc.trim(),
                        soDoanOngCan: parseInt(item.soDoanOngCan) || 0,
                        soMoiBPCan: parseInt(item.soMoiBPCan) || 0,
                        tongMoiHanCan: parseInt(item.tongMoiHanCan) || 0,
                        soDoanOngLam: 0, 
                        soMoiBPLam: 0,   
                        tongMoiHanLam: 0, 
                        ghiChu: ""
                    }));

                    // Cập nhật totalData: Nếu khu vực đã tồn tại, giữ nguyên "Đã làm". Nếu là khu vực mới, thêm vào.
                    totalData = updatedPlanData.map(newPlan => {
                        const existingItem = totalData.find(old => old.khuVuc === newPlan.khuVuc);
                        if (existingItem) {
                            return {
                                ...newPlan,
                                soDoanOngLam: existingItem.soDoanOngLam,
                                soMoiBPLam: existingItem.soMoiBPLam,
                                tongMoiHanLam: existingItem.tongMoiHanLam,
                                ghiChu: existingItem.ghiChu 
                            };
                        }
                        return newPlan;
                    });
                    
                    // Thêm các khu vực cũ (có dữ liệu 'đã làm') không có trong file mới vào lại
                    const existingKhuVucNames = updatedPlanData.map(item => item.khuVuc);
                    totalData.push(...totalData.filter(old => 
                        !existingKhuVucNames.includes(old.khuVuc) && (old.soDoanOngLam > 0 || old.tongMoiHanLam > 0)
                    ));


                    updateTotalDataFromDetail(); // Đồng bộ lại từ chi tiết (nếu có)
                    showTotalView();
                    alert(`Đã tải thành công và cập nhật ${totalData.length} khu vực KẾ HOẠCH!`);
                } catch (error) {
                    alert("Lỗi khi đọc file Kế hoạch. Vui lòng kiểm tra định dạng: " + error.message);
                } finally {
                    document.getElementById('plan-file-input').value = '';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        /** Xử lý file Chi tiết (Detail) */
        function handleDetailUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    const aoa = XLSX.utils.sheet_to_json(worksheet, {
                        header: 1, 
                        range: 0, 
                        raw: false, 
                        defval: "" 
                    });
                    
                    const dataRows = aoa.slice(3); 
                    
                    const khuVucHienTai = currentDetailKhuVuc;
                    let importedData = [];

                    // VỊ TRÍ CỘT ĐÃ ĐƯỢC ĐIỀU CHỈNH 
                    const COL_HANGMUC = 3;             // Cột D
                    const COL_DUONGKINH = 4;           // Cột E (Đường kính danh định)
                    const COL_CHIEUDAY_DANHDINH = 5;   // Cột F (Chiều dày danh định)
                    const COL_CHIEUDAY_THUC = 6;       // Cột G (Chiều dày thực)
                    const COL_CHIEUDAI_ONG = 7;        // Cột H (Chiều dài đoạn ống thay thế)
                    const COL_QUEHAN = 8;              // Cột I (Que hàn sử dụng)
                    const COL_PHUONGAN = 9;            // Cột J (Phương án)
                    const COL_KL_CANLAM = 10;          // Cột K (Đoạn ống cần làm)
                    const COL_MOIHAN_CANLAM = 11;      // Cột L (Tổng số mối hàn cần làm)
                    const COL_MOIBP_CANLAM = 12;       // Cột M (Số mối biện pháp cần làm)
                    const COL_CAT_LAM = 13;            // Cột N (Đã Cắt)
                    const COL_HAN1_LAM = 14;           // Cột O (Đã Hàn mối 1)
                    const COL_HAN2_LAM = 15;           // Cột P (Đã Hàn mối 2)
                    const COL_MOIBP_LAM = 16;          // Cột Q (Số mối biện pháp đã làm)
                    const COL_DOANONG_LAM = 17;        // Cột R (Số đoạn ống đã làm)
                    const COL_GHICHU = 18;             // Cột S
                    
                    const getFloat = (row, index) => {
                        const val = row[index];
                        return typeof val === 'number' ? val : (parseFloat(String(val).replace(/,/g, '.')) || 0);
                    };
                    const getInt = (row, index) => {
                        const val = row[index];
                        return typeof val === 'number' ? val : (parseInt(String(val).replace(/,/g, '.')) || 0);
                    };
                    const getString = (row, index) => (row[index] || '').trim();


                    dataRows.forEach(row => {
                        const hangMuc = getString(row, COL_HANGMUC);
                        const klCanLam = getInt(row, COL_KL_CANLAM);
                        const mhCanLam = getInt(row, COL_MOIHAN_CANLAM);

                        if (!hangMuc || (klCanLam === 0 && mhCanLam === 0)) {
                            return; 
                        }

                        importedData.push({
                            khuVuc: khuVucHienTai, 
                            hangMuc: hangMuc,
                            duongKinh: getFloat(row, COL_DUONGKINH),
                            chieuDayDanhDinh: getFloat(row, COL_CHIEUDAY_DANHDINH),
                            chieuDayThuc: getFloat(row, COL_CHIEUDAY_THUC),
                            chieuDaiDoanOngThayThe: getFloat(row, COL_CHIEUDAI_ONG),
                            phuongAn: getString(row, COL_PHUONGAN),
                            queHanSuDung: getString(row, COL_QUEHAN),
                            
                            khoiLuongCanLam: klCanLam,
                            soMoiHanCanLam: mhCanLam,
                            soMoiBPCanLam: getInt(row, COL_MOIBP_CANLAM),
                            
                            catLam: getInt(row, COL_CAT_LAM),
                            hanMoi1Lam: getInt(row, COL_HAN1_LAM),
                            hanMoi2Lam: getInt(row, COL_HAN2_LAM),
                            soMoiBPLam: getInt(row, COL_MOIBP_LAM),
                            soDoanOngLam: getInt(row, COL_DOANONG_LAM),
                            ghiChu: getString(row, COL_GHICHU)
                        });
                    });

                    // Xóa dữ liệu cũ của khu vực hiện tại và thêm dữ liệu mới
                    detailData = detailData.filter(item => item.khuVuc !== khuVucHienTai);
                    detailData.push(...importedData); 

                    updateTotalDataFromDetail(); 
                    
                    if(document.getElementById('view-detail').style.display === 'block') {
                        applyDetailFilters();
                    } else {
                        showTotalView();
                    }
                    
                    alert(`Đã tải thành công và GHI ĐÈ ${importedData.length} mục dữ liệu CHI TIẾT cho khu vực ${khuVucHienTai}!`);

                } catch (error) {
                    alert("Lỗi khi đọc file Chi tiết. Vui lòng kiểm tra định dạng, HÀNG HEADER chi tiết bắt đầu từ HÀNG SỐ 4 (index 3), và thứ tự cột: " + error.message);
                } finally {
                    document.getElementById('detail-file-input').value = '';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        /** Tải về file Chi tiết (Giữ nguyên)*/
        function downloadDataAsExcel() {
            if (detailData.length === 0) {
                alert("Không có dữ liệu chi tiết để tải về.");
                return;
            }

            const headers = [
                "Khu vực", "Hạng mục", 
                "Đường kính", "Chiều dày Danh Định", "Chiều dày Thực", "Chiều dài đoạn ống thay thế", 
                "Que hàn sử dụng", "Phương án", 
                "KL Cần làm (Đoạn ống)", "Tổng mối hàn CẦN", "Mối BP CẦN", 
                "Đã làm: Cắt", "Đã làm: Hàn mối 1", "Đã làm: Hàn mối 2", "Đã làm: Mối BP", 
                "Đã làm: Đoạn ống", "Ghi chú"
            ];
            
            const dataForExport = detailData.map(item => [
                item.khuVuc, item.hangMuc, 
                item.duongKinh, item.chieuDayDanhDinh, item.chieuDayThuc, item.chieuDaiDoanOngThayThe, 
                item.queHanSuDung, item.phuongAn, 
                item.khoiLuongCanLam, item.soMoiHanCanLam, item.soMoiBPCanLam, 
                item.catLam, item.hanMoi1Lam, item.hanMoi2Lam, item.soMoiBPLam, item.soDoanOngLam, item.ghiChu
            ]);

            const ws = XLSX.utils.aoa_to_sheet([headers, ...dataForExport]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "DuLieuChiTiet");

            XLSX.writeFile(wb, "DuLieuChiTiet_DaiTuLo1_" + new Date().toISOString().slice(0, 10) + ".xlsx");
        }

        // ************************************************************
        // CÁC HÀM XỬ LÝ DỮ LIỆU & GIAO DIỆN (Giữ nguyên logic)
        // ************************************************************
        
        /** Cập nhật dữ liệu tổng hợp từ dữ liệu chi tiết */
        function updateTotalDataFromDetail() {
            const planMapFromDetail = {};
            const summaryMapFromDetail = {};

            // 1. Tính toán lại kế hoạch và thực hiện từ dữ liệu chi tiết
            detailData.forEach(item => {
                const khuVuc = item.khuVuc.trim();
                
                if (!planMapFromDetail[khuVuc]) {
                    planMapFromDetail[khuVuc] = { soDoanOngCan: 0, soMoiBPCan: 0, tongMoiHanCan: 0 };
                    summaryMapFromDetail[khuVuc] = { soDoanOngLam: 0, soMoiBPLam: 0, tongMoiHanLam: 0 };
                }
                
                // Kế hoạch (Can)
                planMapFromDetail[khuVuc].soDoanOngCan += parseInt(item.khoiLuongCanLam || 0);
                planMapFromDetail[khuVuc].soMoiBPCan += parseInt(item.soMoiBPCanLam || 0); 
                planMapFromDetail[khuVuc].tongMoiHanCan += parseInt(item.soMoiHanCanLam || 0);

                // Đã làm (Lam)
                summaryMapFromDetail[khuVuc].soDoanOngLam += parseInt(item.soDoanOngLam || 0);
                summaryMapFromDetail[khuVuc].soMoiBPLam += parseInt(item.soMoiBPLam || 0);
                
                // Tổng mối hàn đã làm = Cắt + Hàn mối 1 + Hàn mối 2 (Nếu có mối 3 thì cộng thêm, hiện tại đang dùng 3 cột thực hiện cho 3 bước chính)
                summaryMapFromDetail[khuVuc].tongMoiHanLam += parseInt(item.catLam || 0) + parseInt(item.hanMoi1Lam || 0) + parseInt(item.hanMoi2Lam || 0); 
            });

            const newTotalData = [];
            
            // 2. Gom tất cả khu vực từ cả 2 nguồn: totalData cũ và detailData mới
            const allKhuVuc = new Set([...totalData.map(item => item.khuVuc), ...Object.keys(planMapFromDetail)]);

            // 3. Xây dựng lại totalData
            allKhuVuc.forEach(khuVuc => {
                const existingItem = totalData.find(old => old.khuVuc === khuVuc);
                const summary = summaryMapFromDetail[khuVuc] || { soDoanOngLam: 0, soMoiBPLam: 0, tongMoiHanLam: 0 };
                const planFromDetail = planMapFromDetail[khuVuc];
                
                let updatedItem = { 
                    khuVuc: khuVuc, 
                    ghiChu: (existingItem ? existingItem.ghiChu : '') || '' 
                };
                
                // Ưu tiên Kế hoạch từ file Kế hoạch tổng (nếu không có Kế hoạch chi tiết)
                if (existingItem && (existingItem.soDoanOngCan > 0 || existingItem.tongMoiHanCan > 0)) {
                    updatedItem.soDoanOngCan = existingItem.soDoanOngCan;
                    updatedItem.soMoiBPCan = existingItem.soMoiBPCan;
                    updatedItem.tongMoiHanCan = existingItem.tongMoiHanCan;
                } 
                // Nếu không có trong file tổng, lấy từ tổng hợp chi tiết
                else if (planFromDetail) {
                    updatedItem.soDoanOngCan = planFromDetail.soDoanOngCan;
                    updatedItem.soMoiBPCan = planFromDetail.soMoiBPCan;
                    updatedItem.tongMoiHanCan = planFromDetail.tongMoiHanCan;
                } else {
                    // Khu vực có trong old totalData nhưng kế hoạch bằng 0 và không có trong detail, giữ nguyên 0
                    updatedItem.soDoanOngCan = 0;
                    updatedItem.soMoiBPCan = 0;
                    updatedItem.tongMoiHanCan = 0;
                }

                // Luôn lấy dữ liệu Đã làm từ tổng hợp Chi tiết
                updatedItem.soDoanOngLam = summary.soDoanOngLam;
                updatedItem.soMoiBPLam = summary.soMoiBPLam;
                updatedItem.tongMoiHanLam = summary.tongMoiHanLam;

                newTotalData.push(updatedItem);
            });

            totalData = newTotalData;
        }
        
        function showTotalView() {
            document.getElementById('view-total').style.display = 'block';
            document.getElementById('view-detail').style.display = 'none';
            currentDetailKhuVuc = '';
            document.getElementById('filterHangMuc').value = '';
            renderTotalTable();
        }

        function showDetailView(khuVuc) {
            currentDetailKhuVuc = khuVuc;
            document.getElementById('detail-header').textContent = `Chi Tiết & Cập Nhật: ${khuVuc}`;
            document.getElementById('current-khuVuc-update').textContent = khuVuc;
            document.getElementById('khuVuc').value = khuVuc;
            
            document.getElementById('view-total').style.display = 'none';
            document.getElementById('view-detail').style.display = 'block';
            
            resetInputForm();
            applyDetailFilters();
        }

        function renderTotalTable() {
            const tableBody = document.getElementById('total-data-body');
            tableBody.innerHTML = ''; 

            const dataToRender = totalData.sort((a, b) => a.khuVuc.localeCompare(b.khuVuc));
            
            let totalCanOng = 0, totalCanBP = 0, totalCanHan = 0;
            let totalLamOng = 0, totalLamBP = 0, totalLamHan = 0;

            dataToRender.forEach(item => {
                const canOng = item.soDoanOngCan;
                const canBP = item.soMoiBPCan;
                const canHan = item.tongMoiHanCan;
                
                const lamOng = item.soDoanOngLam;
                const lamBP = item.soMoiBPLam;
                const lamHan = item.tongMoiHanLam;

                const conOng = canOng - lamOng;
                const conBP = canBP - lamBP;
                const conHan = canHan - lamHan;
                
                const percentOng = canOng > 0 ? (lamOng / canOng) * 100 : (lamOng > 0 ? 100 : 0);
                const percentHan = canHan > 0 ? (lamHan / canHan) * 100 : (lamHan > 0 ? 100 : 0);

                totalCanOng += canOng;
                totalCanBP += canBP;
                totalCanHan += canHan;
                totalLamOng += lamOng;
                totalLamBP += lamBP;
                totalLamHan += lamHan;

                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td onclick="showDetailView('${item.khuVuc}')" style="font-weight: bold; color: #007bff; cursor: pointer;">${item.khuVuc}</td>
                    <td class="text-center">${canOng}</td>
                    <td class="text-center">${canBP}</td>
                    <td class="text-center">${canHan}</td>
                    <td class="text-center" style="background-color: #d4edda;">${lamOng}</td>
                    <td class="text-center" style="background-color: #d4edda;">${lamBP}</td>
                    <td class="text-center" style="background-color: #d4edda;">${lamHan}</td>
                    <td class="text-center">${Math.max(0, conOng)}</td>
                    <td class="text-center">${Math.max(0, conBP)}</td>
                    <td class="text-center">${Math.max(0, conHan)}</td>
                    <td class="text-center" style="background-color: ${percentOng >= 100 ? '#28a745' : percentOng > 0 ? '#ffc107' : '#f8d7da'}; color: ${percentOng >= 100 ? 'white' : 'black'};">${percentOng.toFixed(2)}%</td>
                    <td class="text-center" style="background-color: ${percentHan >= 100 ? '#28a745' : percentHan > 0 ? '#ffc107' : '#f8d7da'}; color: ${percentHan >= 100 ? 'white' : 'black'};">${percentHan.toFixed(2)}%</td>
                    <td>${item.ghiChu}</td>
                `;
            });

            // Thêm dòng tổng cộng
            const totalPercentOng = totalCanOng > 0 ? (totalLamOng / totalCanOng) * 100 : (totalLamOng > 0 ? 100 : 0);
            const totalPercentHan = totalCanHan > 0 ? (totalLamHan / totalCanHan) * 100 : (totalLamHan > 0 ? 100 : 0);

            const totalRow = tableBody.insertRow();
            totalRow.style.fontWeight = 'bold';
            totalRow.style.backgroundColor = '#f0f0f0';
            totalRow.innerHTML = `
                <td style="text-align: center;">TỔNG CỘNG</td>
                <td class="text-center">${totalCanOng}</td>
                <td class="text-center">${totalCanBP}</td>
                <td class="text-center">${totalCanHan}</td>
                <td class="text-center" style="background-color: #c3e6cb;">${totalLamOng}</td>
                <td class="text-center" style="background-color: #c3e6cb;">${totalLamBP}</td>
                <td class="text-center" style="background-color: #c3e6cb;">${totalLamHan}</td>
                <td class="text-center">${Math.max(0, totalCanOng - totalLamOng)}</td>
                <td class="text-center">${Math.max(0, totalCanBP - totalLamBP)}</td>
                <td class="text-center">${Math.max(0, totalCanHan - totalLamHan)}</td>
                <td class="text-center" style="background-color: ${totalPercentOng >= 100 ? '#1e7e34' : totalPercentOng > 0 ? '#d39e00' : '#c63832'}; color: white;">${totalPercentOng.toFixed(2)}%</td>
                <td class="text-center" style="background-color: ${totalPercentHan >= 100 ? '#1e7e34' : totalPercentHan > 0 ? '#d39e00' : '#c63832'}; color: white;">${totalPercentHan.toFixed(2)}%</td>
                <td></td>
            `;
        }

        function renderDetailTable(filteredData) {
            const tableBody = document.getElementById('data-body');
            const tableFoot = document.getElementById('data-tfoot');
            tableBody.innerHTML = ''; 
            tableFoot.innerHTML = '';

            let totalCanOng = 0, totalCanHan = 0, totalCanBP = 0;
            let totalLamCat = 0, totalLamHan1 = 0, totalLamHan2 = 0, totalLamBP = 0, totalLamOng = 0;
            let sttCounter = 1;

            filteredData.forEach(item => {
                const row = tableBody.insertRow();
                row.setAttribute('data-hangmuc', item.hangMuc);
                row.onclick = () => fillFormForUpdate(item);
                
                // Tính tổng
                totalCanOng += item.khoiLuongCanLam;
                totalCanHan += item.soMoiHanCanLam;
                totalCanBP += item.soMoiBPCanLam;
                totalLamCat += item.catLam;
                totalLamHan1 += item.hanMoi1Lam;
                totalLamHan2 += item.hanMoi2Lam;
                totalLamBP += item.soMoiBPLam;
                totalLamOng += item.soDoanOngLam;

                // Render dữ liệu
                row.innerHTML = `
                    <td class="text-center">${sttCounter++}</td>
                    <td>${item.hangMuc}</td>
                    <td class="text-center">${item.duongKinh}</td>
                    <td class="text-center">${item.chieuDayDanhDinh}</td>
                    <td class="text-center">${item.chieuDayThuc}</td>
                    <td class="text-center">${item.chieuDaiDoanOngThayThe || ''}</td>
                    <td>${item.phuongAn}</td>
                    <td>${item.queHanSuDung}</td>
                    <td class="text-center" style="font-weight: bold; background-color: #fff3cd;">${item.khoiLuongCanLam}</td>
                    <td class="text-center" style="font-weight: bold; background-color: #fff3cd;">${item.soMoiHanCanLam}</td>
                    <td class="text-center" style="font-weight: bold; background-color: #fff3cd;">${item.soMoiBPCanLam}</td>
                    <td class="text-center">${item.catLam}</td>
                    <td class="text-center">${item.hanMoi1Lam}</td>
                    <td class="text-center">${item.hanMoi2Lam}</td>
                    <td class="text-center">${item.soMoiBPLam}</td>
                    <td class="text-center" style="font-weight: bold; background-color: #d4edda;">${item.soDoanOngLam}</td>
                    <td>${item.ghiChu}</td>
                `;
            });
            
            // Cập nhật STT cho lần nhập tiếp theo
            document.getElementById('stt').value = sttCounter;


            // Dòng tổng cộng chi tiết
            const totalRow = tableFoot.insertRow();
            totalRow.style.fontWeight = 'bold';
            totalRow.style.backgroundColor = '#e9ecef';
            totalRow.innerHTML = `
                <td colspan="8" style="text-align: center;">TỔNG CỘNG KHU VỰC ${currentDetailKhuVuc}</td>
                <td class="text-center">${totalCanOng}</td>
                <td class="text-center">${totalCanHan}</td>
                <td class="text-center">${totalCanBP}</td>
                <td class="text-center">${totalLamCat}</td>
                <td class="text-center">${totalLamHan1}</td>
                <td class="text-center">${totalLamHan2}</td>
                <td class="text-center">${totalLamBP}</td>
                <td class="text-center">${totalLamOng}</td>
                <td></td>
            `;

            // Cập nhật lại totalData sau khi tính toán tổng chi tiết
            const totalItem = totalData.find(item => item.khuVuc === currentDetailKhuVuc);
            if(totalItem) {
                totalItem.soDoanOngLam = totalLamOng;
                totalItem.soMoiBPLam = totalLamBP;
                // Cập nhật lại cột 'Tổng mối hàn đã làm' trong totalData
                totalItem.tongMoiHanLam = totalLamCat + totalLamHan1 + totalLamHan2; 
                
                // Nếu kế hoạch trong totalData là 0 (đã reset), thì cập nhật từ chi tiết
                if(totalItem.soDoanOngCan === 0 && totalItem.tongMoiHanCan === 0) {
                    totalItem.soDoanOngCan = totalCanOng;
                    totalItem.soMoiBPCan = totalCanBP;
                    totalItem.tongMoiHanCan = totalCanHan;
                }
            }
        }

        function applyDetailFilters() {
            const filterValue = document.getElementById('filterHangMuc').value.toLowerCase();
            const filteredData = detailData.filter(item => 
                item.khuVuc === currentDetailKhuVuc && 
                (item.hangMuc.toLowerCase().includes(filterValue) || item.ghiChu.toLowerCase().includes(filterValue))
            );
            renderDetailTable(filteredData);
        }

        function getFormData() {
            return {
                khuVuc: document.getElementById('khuVuc').value.trim(),
                hangMuc: document.getElementById('hangMuc').value.trim(),
                duongKinh: parseFloat(document.getElementById('duongKinh').value) || 0,
                chieuDayDanhDinh: parseFloat(document.getElementById('chieuDayDanhDinh').value) || 0,
                chieuDayThuc: parseFloat(document.getElementById('chieuDayThuc').value) || 0,
                chieuDaiDoanOngThayThe: parseFloat(document.getElementById('chieuDaiDoanOngThayThe').value) || 0,
                phuongAn: document.getElementById('phuongAn').value.trim(),
                queHanSuDung: document.getElementById('queHanSuDung').value.trim(),
                
                // Kế hoạch (Can)
                khoiLuongCanLam: parseInt(document.getElementById('khoiLuongCanLam').value) || 0,
                soMoiHanCanLam: parseInt(document.getElementById('soMoiHanCanLam').value) || 0,
                soMoiBPCanLam: parseInt(document.getElementById('soMoiBPCanLam').value) || 0, 

                // Thực hiện (Lam)
                catLam: parseInt(document.getElementById('catLam').value) || 0,
                hanMoi1Lam: parseInt(document.getElementById('hanMoi1Lam').value) || 0,
                hanMoi2Lam: parseInt(document.getElementById('hanMoi2Lam').value) || 0, 
                soMoiBPLam: parseInt(document.getElementById('soMoiBPLam').value) || 0,
                soDoanOngLam: parseInt(document.getElementById('soDoanOngLam').value) || 0,
                
                ghiChu: document.getElementById('ghiChu').value.trim(),
            };
        }

        function resetInputForm() {
            document.getElementById('stt').value = (detailData.filter(item => item.khuVuc === currentDetailKhuVuc).length + 1) || 1;
            document.getElementById('hangMuc').value = '';
            document.getElementById('duongKinh').value = '50.80';
            document.getElementById('chieuDayDanhDinh').value = '4.57';
            document.getElementById('chieuDayThuc').value = '';
            document.getElementById('chieuDaiDoanOngThayThe').value = '';
            document.getElementById('phuongAn').value = 'Cắt thay';
            document.getElementById('queHanSuDung').value = 'ER80S-B2';
            
            document.getElementById('khoiLuongCanLam').value = '1';
            document.getElementById('soMoiHanCanLam').value = '2';
            document.getElementById('soMoiBPCanLam').value = '0';
            
            document.getElementById('catLam').value = '0';
            document.getElementById('hanMoi1Lam').value = '0';
            document.getElementById('hanMoi2Lam').value = '0';
            document.getElementById('soMoiBPLam').value = '0';
            document.getElementById('soDoanOngLam').value = '0';
            
            document.getElementById('ghiChu').value = '';
            document.getElementById('add-row-btn').textContent = 'Thêm Mới / Cập Nhật Tiến Độ';
            document.getElementById('add-row-btn').dataset.editingIndex = '';
        }

        function fillFormForUpdate(item) {
            document.getElementById('stt').value = 'CẬP NHẬT'; // Đánh dấu đang sửa
            document.getElementById('hangMuc').value = item.hangMuc;
            document.getElementById('duongKinh').value = item.duongKinh;
            document.getElementById('chieuDayDanhDinh').value = item.chieuDayDanhDinh;
            document.getElementById('chieuDayThuc').value = item.chieuDayThuc;
            document.getElementById('chieuDaiDoanOngThayThe').value = item.chieuDaiDoanOngThayThe;
            document.getElementById('phuongAn').value = item.phuongAn;
            document.getElementById('queHanSuDung').value = item.queHanSuDung;
            
            document.getElementById('khoiLuongCanLam').value = item.khoiLuongCanLam;
            document.getElementById('soMoiHanCanLam').value = item.soMoiHanCanLam;
            document.getElementById('soMoiBPCanLam').value = item.soMoiBPCanLam;
            
            document.getElementById('catLam').value = item.catLam;
            document.getElementById('hanMoi1Lam').value = item.hanMoi1Lam;
            document.getElementById('hanMoi2Lam').value = item.hanMoi2Lam;
            document.getElementById('soMoiBPLam').value = item.soMoiBPLam;
            document.getElementById('soDoanOngLam').value = item.soDoanOngLam;

            document.getElementById('ghiChu').value = item.ghiChu;
            document.getElementById('add-row-btn').textContent = `Cập Nhật Cho Hạng Mục: ${item.hangMuc}`;
            
            // Tìm index của mục đang được chọn
            const index = detailData.findIndex(d => 
                d.khuVuc === item.khuVuc && 
                d.hangMuc === item.hangMuc && 
                d.khoiLuongCanLam === item.khoiLuongCanLam 
            );
            document.getElementById('add-row-btn').dataset.editingIndex = index;
        }


        function handleAddOrUpdateRow() {
            const formData = getFormData();

            if (!formData.hangMuc) {
                alert('Vui lòng nhập Hạng mục.');
                return;
            }

            const editingIndex = document.getElementById('add-row-btn').dataset.editingIndex;
            
            const existingItemIndex = detailData.findIndex(item => 
                item.khuVuc === formData.khuVuc && 
                item.hangMuc === formData.hangMuc
            );

            if (existingItemIndex !== -1 && editingIndex === '') {
                 // Nếu hạng mục đã tồn tại và không phải chế độ sửa
                 const isConfirm = confirm(`Hạng mục "${formData.hangMuc}" đã tồn tại. Bạn muốn CẬP NHẬT tiến độ cho hạng mục này không? (Nếu muốn thêm mới, vui lòng đổi tên Hạng mục)`);
                 if(isConfirm) {
                    detailData[existingItemIndex] = formData;
                 } else {
                     return;
                 }
            } else if (editingIndex !== '') {
                // Chế độ CẬP NHẬT
                detailData[editingIndex] = formData;
            } else {
                // Chế độ THÊM MỚI
                detailData.push(formData);
            }
            
            // Sau khi thay đổi, reset form, cập nhật bảng chi tiết và bảng tổng
            resetInputForm();
            updateTotalDataFromDetail();
            applyDetailFilters();
        }

        // Khởi tạo các sự kiện
        document.getElementById('add-row-btn').addEventListener('click', handleAddOrUpdateRow);

        // Khởi tạo ứng dụng
        document.addEventListener('DOMContentLoaded', () => {
            updateTotalDataFromDetail();
            showTotalView();
        });

    </script>
</body>
</html>