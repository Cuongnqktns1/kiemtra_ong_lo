<script>
    // DỮ LIỆU KHỞI TẠO TỔNG HỢP (totalData): ĐÃ CẬP NHẬT CHÍNH XÁC THEO FILE ẢNH MỚI NHẤT
    let totalData = [
        // 1. Quá nhiệt trung gian
        {"khuVuc": "Quá nhiệt trung gian", "soDoanOngCan": 167, "soMoiBPCan": 141, "tongMoiHanCan": 467, "soDoanOngLam": 101, "soMoiBPLam": 20, "tongMoiHanLam": 247, "ghiChu": ""},
        // 2. Quá nhiệt cấp 1
        {"khuVuc": "Quá nhiệt cấp 1", "soDoanOngCan": 97, "soMoiBPCan": 180, "tongMoiHanCan": 373, "soDoanOngLam": 80, "soMoiBPLam": 0, "tongMoiHanLam": 164, "ghiChu": ""},
        // 3. Quá nhiệt cấp 3
        {"khuVuc": "Quá nhiệt cấp 3", "soDoanOngCan": 422, "soMoiBPCan": 0, "tongMoiHanCan": 844, "soDoanOngLam": 9, "soMoiBPLam": 0, "tongMoiHanLam": 230, "ghiChu": ""},
        // 4. Bộ hâm nước
        {"khuVuc": "Bộ hâm nước", "soDoanOngCan": 115, "soMoiBPCan": 62, "tongMoiHanCan": 292, "soDoanOngLam": 67, "soMoiBPLam": 0, "tongMoiHanLam": 145, "ghiChu": ""},
        // 5. Quá nhiệt hộp: Trần
        {"khuVuc": "Quá nhiệt hộp: Trần", "soDoanOngCan": 8, "soMoiBPCan": 8, "tongMoiHanCan": 20, "soDoanOngLam": 0, "soMoiBPLam": 0, "tongMoiHanLam": 0, "ghiChu": ""},
        // 6. Ống sinh hơi (Dữ liệu trống trong file, đặt về 0)
        {"khuVuc": "Ống sinh hơi", "soDoanOngCan": 0, "soMoiBPCan": 0, "tongMoiHanCan": 0, "soDoanOngLam": 0, "soMoiBPLam": 0, "tongMoiHanLam": 0, "ghiChu": ""},
        // 7. Phục hồi giàn 82
        {"khuVuc": "Phục hồi giàn 82", "soDoanOngCan": 40, "soMoiBPCan": 63, "tongMoiHanCan": 101, "soDoanOngLam": 0, "soMoiBPLam": 42, "tongMoiHanLam": 66, "ghiChu": ""},
    ];

    let detailData = [
        // Dữ liệu chi tiết mẫu cho Quá nhiệt trung gian
        {
            "khuVuc":"Quá nhiệt trung gian", 
            "hangMuc":"TQNTG T5/ Giàn 5-1", 
            "duongKinh":50.8, 
            "chieuDayDanhDinh":4.19, 
            "chieuDayThuc":3.14,
            "chieuDaiDoanOngThayThe": 2.5, 
            "phuongAn":"Cắt thay",
            "queHanSuDung":"ER70S-6",
            "khoiLuongCanLam":1,
            "soMoiHanCanLam":2, 
            "soMoiBPCanLam":1, 
            "catLam":1,
            "hanMoi1Lam":1,
            "hanMoi2Lam":1,
            "soMoiBPLam":1,
            "soDoanOngLam":1,
            "ghiChu":"Hoàn thành"
        },
        // Dữ liệu chi tiết mẫu cho Quá nhiệt cấp 1
        {
            "khuVuc":"Quá nhiệt cấp 1", 
            "hangMuc":"TQNC1 T5/ Giàn 5-4", 
            "duongKinh":50.8, 
            "chieuDayDanhDinh":4.57, 
            "chieuDayThuc":3.4,
            "chieuDaiDoanOngThayThe": 1.2, 
            "phuongAn":"Cắt thay",
            "queHanSuDung":"ER80S-B2",
            "khoiLuongCanLam":1,
            "soMoiHanCanLam":2,
            "soMoiBPCanLam":0, 
            "catLam":1,
            "hanMoi1Lam":1,
            "hanMoi2Lam":1,
            "soMoiBPLam":0,
            "soDoanOngLam":1,
            "ghiChu":"Đã hàn xong"
        },
    ];
    let currentDetailKhuVuc = '';

    // ************************************************************
    // CHỨC NĂNG IMPORT/EXPORT (Giữ nguyên logic)
    // ************************************************************

    /** Xử lý file Kế hoạch (Plan) */
    function handlePlanUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                
                const newPlanData = XLSX.utils.sheet_to_json(worksheet, {
                    header: ["STT_Ignore", "khuVuc", "soDoanOngCan", "soMoiBPCan", "tongMoiHanCan"],
                    range: 2, 
                    raw: false
                });

                let updatedPlanData = newPlanData.filter(item => item.khuVuc).map(item => ({
                    khuVuc: item.khuVuc.trim(),
                    soDoanOngCan: parseInt(item.soDoanOngCan) || 0,
                    soMoiBPCan: parseInt(item.soMoiBPCan) || 0,
                    tongMoiHanCan: parseInt(item.tongMoiHanCan) || 0,
                    soDoanOngLam: 0, 
                    soMoiBPLam: 0,   
                    tongMoiHanLam: 0, 
                    ghiChu: ""
                }));

                // Cập nhật totalData: Nếu khu vực đã tồn tại, giữ nguyên "Đã làm". Nếu là khu vực mới, thêm vào.
                totalData = updatedPlanData.map(newPlan => {
                    const existingItem = totalData.find(old => old.khuVuc === newPlan.khuVuc);
                    if (existingItem) {
                        return {
                            ...newPlan,
                            soDoanOngLam: existingItem.soDoanOngLam,
                            soMoiBPLam: existingItem.soMoiBPLam,
                            tongMoiHanLam: existingItem.tongMoiHanLam,
                            ghiChu: existingItem.ghiChu 
                        };
                    }
                    return newPlan;
                });
                
                // Thêm các khu vực cũ (có dữ liệu 'đã làm') không có trong file mới vào lại
                const existingKhuVucNames = updatedPlanData.map(item => item.khuVuc);
                totalData.push(...totalData.filter(old => 
                    !existingKhuVucNames.includes(old.khuVuc) && (old.soDoanOngLam > 0 || old.tongMoiHanLam > 0)
                ));


                updateTotalDataFromDetail(); // Đồng bộ lại từ chi tiết (nếu có)
                showTotalView();
                alert(`Đã tải thành công và cập nhật ${totalData.length} khu vực KẾ HOẠCH!`);
            } catch (error) {
                alert("Lỗi khi đọc file Kế hoạch. Vui lòng kiểm tra định dạng: " + error.message);
            } finally {
                document.getElementById('plan-file-input').value = '';
            }
        };
        reader.readAsArrayBuffer(file);
    }

    /** Xử lý file Chi tiết (Detail) */
    function handleDetailUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                
                const aoa = XLSX.utils.sheet_to_json(worksheet, {
                    header: 1, 
                    range: 0, 
                    raw: false, 
                    defval: "" 
                });
                
                const dataRows = aoa.slice(3); 
                
                const khuVucHienTai = currentDetailKhuVuc;
                let importedData = [];

                // VỊ TRÍ CỘT ĐÃ ĐƯỢC ĐIỀU CHỈNH 
                const COL_HANGMUC = 3;           // Cột D
                const COL_DUONGKINH = 4;           // Cột E (Đường kính danh định)
                const COL_CHIEUDAY_DANHDINH = 5;   // Cột F (Chiều dày danh định)
                const COL_CHIEUDAY_THUC = 6;       // Cột G (Chiều dày thực)
                const COL_CHIEUDAI_ONG = 7;        // Cột H (Chiều dài đoạn ống thay thế)
                const COL_QUEHAN = 8;              // Cột I (Que hàn sử dụng)
                const COL_PHUONGAN = 9;            // Cột J (Phương án)
                const COL_KL_CANLAM = 10;          // Cột K (Đoạn ống cần làm)
                const COL_MOIHAN_CANLAM = 11;      // Cột L (Tổng số mối hàn cần làm)
                const COL_MOIBP_CANLAM = 12;       // Cột M (Số mối biện pháp cần làm)
                const COL_CAT_LAM = 13;            // Cột N (Đã Cắt)
                const COL_HAN1_LAM = 14;           // Cột O (Đã Hàn mối 1)
                const COL_HAN2_LAM = 15;           // Cột P (Đã Hàn mối 2)
                const COL_MOIBP_LAM = 16;          // Cột Q (Số mối biện pháp đã làm)
                const COL_DOANONG_LAM = 17;        // Cột R (Số đoạn ống đã làm)
                const COL_GHICHU = 18;             // Cột S
                
                const getFloat = (row, index) => {
                    const val = row[index];
                    return typeof val === 'number' ? val : (parseFloat(String(val).replace(/,/g, '.')) || 0);
                };
                const getInt = (row, index) => {
                    const val = row[index];
                    return typeof val === 'number' ? val : (parseInt(String(val).replace(/,/g, '.')) || 0);
                };
                const getString = (row, index) => (row[index] || '').trim();


                dataRows.forEach(row => {
                    const hangMuc = getString(row, COL_HANGMUC);
                    const klCanLam = getInt(row, COL_KL_CANLAM);
                    const mhCanLam = getInt(row, COL_MOIHAN_CANLAM);

                    if (!hangMuc || (klCanLam === 0 && mhCanLam === 0)) {
                        return; 
                    }

                    importedData.push({
                        khuVuc: khuVucHienTai, 
                        hangMuc: hangMuc,
                        duongKinh: getFloat(row, COL_DUONGKINH),
                        chieuDayDanhDinh: getFloat(row, COL_CHIEUDAY_DANHDINH),
                        chieuDayThuc: getFloat(row, COL_CHIEUDAY_THUC),
                        chieuDaiDoanOngThayThe: getFloat(row, COL_CHIEUDAI_ONG),
                        phuongAn: getString(row, COL_PHUONGAN),
                        queHanSuDung: getString(row, COL_QUEHAN),
                        
                        khoiLuongCanLam: klCanLam,
                        soMoiHanCanLam: mhCanLam,
                        soMoiBPCanLam: getInt(row, COL_MOIBP_CANLAM),
                        
                        catLam: getInt(row, COL_CAT_LAM),
                        hanMoi1Lam: getInt(row, COL_HAN1_LAM),
                        hanMoi2Lam: getInt(row, COL_HAN2_LAM),
                        soMoiBPLam: getInt(row, COL_MOIBP_LAM),
                        soDoanOngLam: getInt(row, COL_DOANONG_LAM),
                        ghiChu: getString(row, COL_GHICHU)
                    });
                });

                // Xóa dữ liệu cũ của khu vực hiện tại và thêm dữ liệu mới
                detailData = detailData.filter(item => item.khuVuc !== khuVucHienTai);
                detailData.push(...importedData); 

                updateTotalDataFromDetail(); 
                
                if(document.getElementById('view-detail').style.display === 'block') {
                    applyDetailFilters();
                } else {
                    showTotalView();
                }
                
                alert(`Đã tải thành công và GHI ĐÈ ${importedData.length} mục dữ liệu CHI TIẾT cho khu vực ${khuVucHienTai}!`);

            } catch (error) {
                alert("Lỗi khi đọc file Chi tiết. Vui lòng kiểm tra định dạng, HÀNG HEADER chi tiết bắt đầu từ HÀNG SỐ 4 (index 3), và thứ tự cột: " + error.message);
            } finally {
                document.getElementById('detail-file-input').value = '';
            }
        };
        reader.readAsArrayBuffer(file);
    }

    /** Tải về file Chi tiết (Giữ nguyên)*/
    function downloadDataAsExcel() {
        if (detailData.length === 0) {
            alert("Không có dữ liệu chi tiết để tải về.");
            return;
        }

        const headers = [
            "Khu vực", "Hạng mục", 
            "Đường kính", "Chiều dày Danh Định", "Chiều dày Thực", "Chiều dài đoạn ống thay thế", 
            "Que hàn sử dụng", "Phương án", 
            "KL Cần làm (Đoạn ống)", "Tổng mối hàn CẦN", "Mối BP CẦN", 
            "Đã làm: Cắt", "Đã làm: Hàn mối 1", "Đã làm: Hàn mối 2", "Đã làm: Mối BP", 
            "Đã làm: Đoạn ống", "Ghi chú"
        ];
        
        const dataForExport = detailData.map(item => [
            item.khuVuc, item.hangMuc, 
            item.duongKinh, item.chieuDayDanhDinh, item.chieuDayThuc, item.chieuDaiDoanOngThayThe, 
            item.queHanSuDung, item.phuongAn, 
            item.khoiLuongCanLam, item.soMoiHanCanLam, item.soMoiBPCanLam, 
            item.catLam, item.hanMoi1Lam, item.hanMoi2Lam, item.soMoiBPLam, item.soDoanOngLam, item.ghiChu
        ]);

        const ws = XLSX.utils.aoa_to_sheet([headers, ...dataForExport]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "DuLieuChiTiet");

        XLSX.writeFile(wb, "DuLieuChiTiet_DaiTuLo1_" + new Date().toISOString().slice(0, 10) + ".xlsx");
    }

    // ************************************************************
    // CÁC HÀM XỬ LÝ DỮ LIỆU & GIAO DIỆN
    // ************************************************************
    
    /** Cập nhật dữ liệu tổng hợp từ dữ liệu chi tiết (ĐÃ SỬA LOGIC) */
    function updateTotalDataFromDetail() {
        const planMapFromDetail = {};
        const summaryMapFromDetail = {};

        // 1. Tính toán lại kế hoạch và thực hiện từ dữ liệu chi tiết
        detailData.forEach(item => {
            const khuVuc = item.khuVuc.trim();
            
            if (!planMapFromDetail[khuVuc]) {
                planMapFromDetail[khuVuc] = { soDoanOngCan: 0, soMoiBPCan: 0, tongMoiHanCan: 0 };
                summaryMapFromDetail[khuVuc] = { soDoanOngLam: 0, soMoiBPLam: 0, tongMoiHanLam: 0 };
            }
            
            // Kế hoạch (Can) - Lấy từ chi tiết
            planMapFromDetail[khuVuc].soDoanOngCan += parseInt(item.khoiLuongCanLam || 0);
            planMapFromDetail[khuVuc].soMoiBPCan += parseInt(item.soMoiBPCanLam || 0); 
            planMapFromDetail[khuVuc].tongMoiHanCan += parseInt(item.soMoiHanCanLam || 0);

            // Đã làm (Lam) - Lấy từ chi tiết
            summaryMapFromDetail[khuVuc].soDoanOngLam += parseInt(item.soDoanOngLam || 0);
            summaryMapFromDetail[khuVuc].soMoiBPLam += parseInt(item.soMoiBPLam || 0);
            
            // Tổng mối hàn đã làm = Cắt + Hàn mối 1 + Hàn mối 2 
            summaryMapFromDetail[khuVuc].tongMoiHanLam += parseInt(item.catLam || 0) + parseInt(item.hanMoi1Lam || 0) + parseInt(item.hanMoi2Lam || 0); 
        });

        const newTotalData = [];
        
        // 2. Gom tất cả khu vực từ cả 2 nguồn: totalData cũ và detailData mới
        const allKhuVuc = new Set([...totalData.map(item => item.khuVuc), ...Object.keys(planMapFromDetail)]);

        // 3. Xây dựng lại totalData với logic ưu tiên Kế hoạch từ Chi tiết
        allKhuVuc.forEach(khuVuc => {
            const existingItem = totalData.find(old => old.khuVuc === khuVuc);
            const summary = summaryMapFromDetail[khuVuc] || { soDoanOngLam: 0, soMoiBPLam: 0, tongMoiHanLam: 0 };
            const planFromDetail = planMapFromDetail[khuVuc];
            
            let updatedItem = { 
                khuVuc: khuVuc, 
                ghiChu: (existingItem ? existingItem.ghiChu : '') || '' 
            };
            
            // LOGIC ĐÃ SỬA ĐỔI: ƯU TIÊN KẾ HOẠCH TỪ CHI TIẾT
            const hasDetailPlan = planFromDetail && (planFromDetail.soDoanOngCan > 0 || planFromDetail.tongMoiHanCan > 0);
            
            if (hasDetailPlan) {
                // Ưu tiên: Sử dụng Kế hoạch TỪ DỮ LIỆU CHI TIẾT
                updatedItem.soDoanOngCan = planFromDetail.soDoanOngCan;
                updatedItem.soMoiBPCan = planFromDetail.soMoiBPCan;
                updatedItem.tongMoiHanCan = planFromDetail.tongMoiHanCan;
            } else if (existingItem) {
                // Dự phòng: Sử dụng Kế hoạch TỪ FILE TỔNG nếu Kế hoạch chi tiết bằng 0/không tồn tại
                updatedItem.soDoanOngCan = existingItem.soDoanOngCan;
                updatedItem.soMoiBPCan = existingItem.soMoiBPCan;
                updatedItem.tongMoiHanCan = existingItem.tongMoiHanCan;
            } else {
                // Trường hợp không có kế hoạch nào 
                updatedItem.soDoanOngCan = 0;
                updatedItem.soMoiBPCan = 0;
                updatedItem.tongMoiHanCan = 0;
            }

            // Thực hiện (Lam): LUÔN LUÔN LẤY TỪ DỮ LIỆU CHI TIẾT
            updatedItem.soDoanOngLam = summary.soDoanOngLam;
            updatedItem.soMoiBPLam = summary.soMoiBPLam;
            updatedItem.tongMoiHanLam = summary.tongMoiHanLam;

            // Bỏ qua nếu Kế hoạch và Thực hiện đều bằng 0
            if (updatedItem.soDoanOngCan === 0 && updatedItem.tongMoiHanCan === 0 && updatedItem.soDoanOngLam === 0 && updatedItem.tongMoiHanLam === 0) {
                return;
            }

            newTotalData.push(updatedItem);
        });

        totalData = newTotalData;
        renderTotalTable();
    }


    /** Hiển thị bảng tổng hợp */
    function renderTotalTable() {
        const tbody = document.getElementById('total-data-body');
        tbody.innerHTML = '';
        let totalSoDoanOngCan = 0;
        let totalSoMoiBPCan = 0;
        let totalTongMoiHanCan = 0;
        let totalSoDoanOngLam = 0;
        let totalSoMoiBPLam = 0;
        let totalTongMoiHanLam = 0;

        totalData.forEach(item => {
            // Tính toán cột còn lại
            const soDoanOngConLai = item.soDoanOngCan - item.soDoanOngLam;
            const soMoiBPConLai = item.soMoiBPCan - item.soMoiBPLam;
            const tongMoiHanConLai = item.tongMoiHanCan - item.tongMoiHanLam;

            // Tính toán cột % Hoàn thành
            const percentDoanOng = item.soDoanOngCan > 0 ? (item.soDoanOngLam / item.soDoanOngCan * 100).toFixed(1) : 0;
            const percentMoiHan = item.tongMoiHanCan > 0 ? (item.tongMoiHanLam / item.tongMoiHanCan * 100).toFixed(1) : 0;

            const row = tbody.insertRow();
            row.onclick = () => showDetailView(item.khuVuc);
            
            row.insertCell().textContent = item.khuVuc; // Khu vực
            row.insertCell().textContent = item.soDoanOngCan;
            row.insertCell().textContent = item.soMoiBPCan;
            row.insertCell().textContent = item.tongMoiHanCan;
            row.insertCell().textContent = item.soDoanOngLam;
            row.insertCell().textContent = item.soMoiBPLam;
            row.insertCell().textContent = item.tongMoiHanLam;
            row.insertCell().textContent = soDoanOngConLai;
            row.insertCell().textContent = soMoiBPConLai;
            row.insertCell().textContent = tongMoiHanConLai;
            
            const cellPercentOng = row.insertCell();
            cellPercentOng.textContent = percentDoanOng + '%';
            cellPercentOng.style.backgroundColor = percentDoanOng == 100 ? '#d4edda' : (percentDoanOng > 0 ? '#fff3cd' : '');
            
            const cellPercentHan = row.insertCell();
            cellPercentHan.textContent = percentMoiHan + '%';
            cellPercentHan.style.backgroundColor = percentMoiHan == 100 ? '#d4edda' : (percentMoiHan > 0 ? '#fff3cd' : '');
            
            row.insertCell().textContent = item.ghiChu;

            // Tính tổng cộng
            totalSoDoanOngCan += item.soDoanOngCan;
            totalSoMoiBPCan += item.soMoiBPCan;
            totalTongMoiHanCan += item.tongMoiHanCan;
            totalSoDoanOngLam += item.soDoanOngLam;
            totalSoMoiBPLam += item.soMoiBPLam;
            totalTongMoiHanLam += item.tongMoiHanLam;
        });

        // Thêm hàng Tổng cộng
        const tfoot = document.createElement('tfoot');
        const totalRow = tfoot.insertRow();
        totalRow.style.fontWeight = 'bold';
        totalRow.style.backgroundColor = '#007bff';
        totalRow.style.color = 'white';
        
        const totalPercentDoanOng = totalSoDoanOngCan > 0 ? (totalSoDoanOngLam / totalSoDoanOngCan * 100).toFixed(1) : 0;
        const totalPercentMoiHan = totalTongMoiHanCan > 0 ? (totalTongMoiHanLam / totalTongMoiHanCan * 100).toFixed(1) : 0;

        totalRow.insertCell().textContent = "TỔNG CỘNG";
        totalRow.insertCell().textContent = totalSoDoanOngCan;
        totalRow.insertCell().textContent = totalSoMoiBPCan;
        totalRow.insertCell().textContent = totalTongMoiHanCan;
        totalRow.insertCell().textContent = totalSoDoanOngLam;
        totalRow.insertCell().textContent = totalSoMoiBPLam;
        totalRow.insertCell().textContent = totalTongMoiHanLam;
        totalRow.insertCell().textContent = totalSoDoanOngCan - totalSoDoanOngLam;
        totalRow.insertCell().textContent = totalSoMoiBPCan - totalSoMoiBPLam;
        totalRow.insertCell().textContent = totalTongMoiHanCan - totalTongMoiHanLam;
        totalRow.insertCell().textContent = totalPercentDoanOng + '%';
        totalRow.insertCell().textContent = totalPercentMoiHan + '%';
        totalRow.insertCell().textContent = "";

        const existingTfoot = document.querySelector('#total-data-table tfoot');
        if (existingTfoot) existingTfoot.remove();
        document.getElementById('total-data-table').appendChild(tfoot);

        // Hiển thị nút quản lý file kế hoạch
        document.getElementById('hidden-file-management').style.display = 'block';
    }


    /** Chuyển sang chế độ xem chi tiết */
    function showDetailView(khuVuc) {
        currentDetailKhuVuc = khuVuc;
        document.getElementById('view-total').style.display = 'none';
        document.getElementById('hidden-file-management').style.display = 'none';
        document.getElementById('view-detail').style.display = 'block';
        document.getElementById('detail-header').textContent = `CHI TIẾT TIẾN ĐỘ KHU VỰC: ${khuVuc}`;
        document.getElementById('khuVuc').value = khuVuc;
        document.getElementById('current-khuVuc-update').textContent = khuVuc;
        document.getElementById('filterHangMuc').value = '';
        applyDetailFilters();
        resetForm();
    }

    /** Chuyển về chế độ xem tổng hợp */
    function showTotalView() {
        document.getElementById('view-total').style.display = 'block';
        document.getElementById('hidden-file-management').style.display = 'block';
        document.getElementById('view-detail').style.display = 'none';
        renderTotalTable();
    }

    /** Lọc và hiển thị bảng chi tiết */
    function applyDetailFilters() {
        const tbody = document.getElementById('data-body');
        const filterText = document.getElementById('filterHangMuc').value.toLowerCase().trim();
        tbody.innerHTML = '';
        let sttCounter = 1;
        let filteredData = detailData.filter(item => item.khuVuc === currentDetailKhuVuc && item.hangMuc.toLowerCase().includes(filterText));

        // Khởi tạo các biến tổng cộng cho tfoot
        let sumKLCan = 0, sumMoiHanCan = 0, sumMoiBPCan = 0;
        let sumCatLam = 0, sumHan1Lam = 0, sumHan2Lam = 0, sumMoiBPLam = 0, sumDoanOngLam = 0;

        filteredData.forEach((item, index) => {
            const row = tbody.insertRow();
            row.onclick = () => loadRowToForm(item, index);
            
            const totalMoiHanLam = (item.catLam || 0) + (item.hanMoi1Lam || 0) + (item.hanMoi2Lam || 0);

            // Cột STT, Hạng mục, Thông số vật tư, Phương án
            row.insertCell().textContent = sttCounter++; 
            row.insertCell().textContent = item.hangMuc + ` (${item.khuVuc})`; 
            row.insertCell().textContent = item.duongKinh || '';
            row.insertCell().textContent = item.chieuDayDanhDinh || '';
            row.insertCell().textContent = item.chieuDayThuc || '';
            row.insertCell().textContent = item.chieuDaiDoanOngThayThe || '';
            row.insertCell().textContent = item.phuongAn || '';
            row.insertCell().textContent = item.queHanSuDung || '';
            
            // Cột Kế hoạch (CẦN LÀM)
            row.insertCell().textContent = item.khoiLuongCanLam || '';
            row.insertCell().textContent = item.soMoiHanCanLam || '';
            row.insertCell().textContent = item.soMoiBPCanLam || '';
            
            // Cột Thực hiện (ĐÃ LÀM)
            row.insertCell().textContent = item.catLam || 0;
            row.insertCell().textContent = item.hanMoi1Lam || 0;
            row.insertCell().textContent = item.hanMoi2Lam || 0;
            row.insertCell().textContent = item.soMoiBPLam || 0;
            row.insertCell().textContent = item.soDoanOngLam || 0;
            
            // Cột Ghi chú
            row.insertCell().textContent = item.ghiChu || '';

            // Tính tổng
            sumKLCan += parseInt(item.khoiLuongCanLam || 0);
            sumMoiHanCan += parseInt(item.soMoiHanCanLam || 0);
            sumMoiBPCan += parseInt(item.soMoiBPCanLam || 0);
            sumCatLam += parseInt(item.catLam || 0);
            sumHan1Lam += parseInt(item.hanMoi1Lam || 0);
            sumHan2Lam += parseInt(item.hanMoi2Lam || 0);
            sumMoiBPLam += parseInt(item.soMoiBPLam || 0);
            sumDoanOngLam += parseInt(item.soDoanOngLam || 0);
        });

        // Cập nhật tfoot
        const tfoot = document.getElementById('data-tfoot');
        tfoot.innerHTML = '';
        const footerRow = tfoot.insertRow();
        footerRow.style.fontWeight = 'bold';
        footerRow.style.backgroundColor = '#f1f1f1';
        
        footerRow.insertCell().textContent = ''; // STT
        footerRow.insertCell().textContent = 'TỔNG CỘNG';
        footerRow.insertCell().colSpan = 6; // Gộp cột thông số
        
        footerRow.insertCell().textContent = sumKLCan;
        footerRow.insertCell().textContent = sumMoiHanCan;
        footerRow.insertCell().textContent = sumMoiBPCan;
        
        footerRow.insertCell().textContent = sumCatLam;
        footerRow.insertCell().textContent = sumHan1Lam;
        footerRow.insertCell().textContent = sumHan2Lam;
        footerRow.insertCell().textContent = sumMoiBPLam;
        footerRow.insertCell().textContent = sumDoanOngLam;

        footerRow.insertCell().textContent = ''; // Ghi chú

        // Cập nhật STT tiếp theo
        document.getElementById('stt').value = filteredData.length + 1;
    }

    /** Thêm hàng mới hoặc cập nhật tiến độ */
    document.getElementById('add-row-btn').addEventListener('click', () => {
        const khuVuc = document.getElementById('khuVuc').value;
        const hangMuc = document.getElementById('hangMuc').value.trim();
        const sttForm = parseInt(document.getElementById('stt').value);
        
        if (!hangMuc) {
            alert("Hạng mục không được để trống!");
            return;
        }

        const newData = {
            khuVuc: khuVuc,
            hangMuc: hangMuc,
            duongKinh: parseFloat(document.getElementById('duongKinh').value) || 0,
            chieuDayDanhDinh: parseFloat(document.getElementById('chieuDayDanhDinh').value) || 0,
            chieuDayThuc: parseFloat(document.getElementById('chieuDayThuc').value) || 0,
            chieuDaiDoanOngThayThe: parseFloat(document.getElementById('chieuDaiDoanOngThayThe').value) || 0,
            phuongAn: document.getElementById('phuongAn').value,
            queHanSuDung: document.getElementById('queHanSuDung').value,
            
            khoiLuongCanLam: parseInt(document.getElementById('khoiLuongCanLam').value) || 0,
            soMoiHanCanLam: parseInt(document.getElementById('soMoiHanCanLam').value) || 0,
            soMoiBPCanLam: parseInt(document.getElementById('soMoiBPCanLam').value) || 0,
            
            catLam: parseInt(document.getElementById('catLam').value) || 0,
            hanMoi1Lam: parseInt(document.getElementById('hanMoi1Lam').value) || 0,
            hanMoi2Lam: parseInt(document.getElementById('hanMoi2Lam').value) || 0,
            soMoiBPLam: parseInt(document.getElementById('soMoiBPLam').value) || 0,
            soDoanOngLam: parseInt(document.getElementById('soDoanOngLam').value) || 0,
            
            ghiChu: document.getElementById('ghiChu').value.trim()
        };

        const existingIndex = detailData.findIndex(item => item.khuVuc === khuVuc && item.hangMuc === hangMuc);

        if (existingIndex !== -1) {
            // Cập nhật (Sử dụng STT để kiểm tra lại, nhưng ưu tiên Hạng mục + Khu vực là key duy nhất)
            detailData[existingIndex] = newData;
            alert(`Đã CẬP NHẬT tiến độ cho hạng mục: ${hangMuc}`);
        } else {
            // Thêm mới
            detailData.push(newData);
            alert(`Đã THÊM MỚI hạng mục: ${hangMuc}`);
        }

        updateTotalDataFromDetail();
        applyDetailFilters();
        resetForm();
    });

    /** Load dữ liệu từ hàng vào form để chỉnh sửa */
    function loadRowToForm(item, index) {
        document.getElementById('stt').value = index + 1; // STT trong bảng chi tiết (chỉ để hiển thị)
        document.getElementById('khuVuc').value = item.khuVuc;
        document.getElementById('hangMuc').value = item.hangMuc;
        document.getElementById('duongKinh').value = item.duongKinh;
        document.getElementById('chieuDayDanhDinh').value = item.chieuDayDanhDinh;
        document.getElementById('chieuDayThuc').value = item.chieuDayThuc;
        document.getElementById('chieuDaiDoanOngThayThe').value = item.chieuDaiDoanOngThayThe;
        document.getElementById('phuongAn').value = item.phuongAn;
        document.getElementById('queHanSuDung').value = item.queHanSuDung;

        document.getElementById('khoiLuongCanLam').value = item.khoiLuongCanLam;
        document.getElementById('soMoiHanCanLam').value = item.soMoiHanCanLam;
        document.getElementById('soMoiBPCanLam').value = item.soMoiBPCanLam;

        document.getElementById('catLam').value = item.catLam;
        document.getElementById('hanMoi1Lam').value = item.hanMoi1Lam;
        document.getElementById('hanMoi2Lam').value = item.hanMoi2Lam;
        document.getElementById('soMoiBPLam').value = item.soMoiBPLam;
        document.getElementById('soDoanOngLam').value = item.soDoanOngLam;
        
        document.getElementById('ghiChu').value = item.ghiChu;
    }

    /** Reset form nhập liệu */
    function resetForm() {
        // Giữ lại Khu vực và STT
        const currentKhuVuc = document.getElementById('khuVuc').value;
        const nextStt = document.getElementById('data-body').rows.length + 1;

        // Xóa/Đặt lại các trường còn lại về giá trị mặc định/ban đầu
        document.getElementById('stt').value = nextStt;
        document.getElementById('hangMuc').value = '';
        document.getElementById('duongKinh').value = '50.80';
        document.getElementById('chieuDayDanhDinh').value = '4.57';
        document.getElementById('chieuDayThuc').value = '3.41';
        document.getElementById('chieuDaiDoanOngThayThe').value = '';
        document.getElementById('queHanSuDung').value = 'ER80S-B2';
        document.getElementById('phuongAn').value = 'Cắt thay';
        document.getElementById('khoiLuongCanLam').value = '1';
        document.getElementById('soMoiHanCanLam').value = '2';
        document.getElementById('soMoiBPCanLam').value = '0';
        document.getElementById('catLam').value = '0';
        document.getElementById('hanMoi1Lam').value = '0';
        document.getElementById('hanMoi2Lam').value = '0';
        document.getElementById('soMoiBPLam').value = '0';
        document.getElementById('soDoanOngLam').value = '0';
        document.getElementById('ghiChu').value = '';
        
        document.getElementById('hangMuc').focus();
    }

    // Khởi tạo bảng tổng hợp khi tải trang
    window.onload = function() {
        updateTotalDataFromDetail(); 
        showTotalView();
    };

</script>
